#!/usr/bin/env python3
"""
Скрипт массового исправления ошибок i18n в компонентах.

Проблемы:
1. {'keyName'} вместо {t('keyName')} в TSX файлах (ключи показываются вместо текста)
2. (main).contract-data.* сырые ключи вместо реального текста в contract-data.ts
3. Обрезанные русские переводы в labels файлах

Запуск:
  python3 scripts/fix_i18n_raw_keys.py --check   # Показать проблемы
  python3 scripts/fix_i18n_raw_keys.py --fix      # Исправить
"""

import re
import os
import sys
import json
from pathlib import Path
from typing import Dict, List, Tuple

BASE_DIR = Path(__file__).parent.parent / "apps" / "frontend" / "src"

# ============================================================================
# ЧАСТЬ 1: Замена {'key'} → {t('key')} в TSX файлах
# ============================================================================

# Паттерн: {'camelCaseKey'} в JSX — это ключ перевода, который забыли обернуть в t()
# Ключ: начинается с маленькой латинской буквы, содержит буквы/цифры, длина >= 3
# Исключения: aria-label, className, key=, type=, role=, id=, name=, htmlFor=
EXCLUDED_ATTRS = {'aria-label', 'className', 'key', 'type', 'role', 'id', 'name', 'htmlFor', 'data-testid'}

# Ключи, которые точно являются ключами перевода (все маленькие)
KNOWN_SIMPLE_KEYS = {
    'subtitle', 'checking', 'address', 'reviews', 'warnings', 'back',
    'hotline', 'prosecutor', 'close', 'deposit', 'repairs', 'access',
    'utilities', 'quote', 'recommendation', 'critical', 'result',
    'saved', 'save', 'remove', 'article', 'discount', 'source',
    'checked', 'done', 'cancel', 'submitting', 'pros', 'cons', 'next',
}

def is_translation_key(key: str) -> bool:
    """Определяет, является ли строка ключом перевода."""
    if not key or len(key) < 2:
        return False
    # Только латиница + цифры
    if not re.match(r'^[a-zA-Z][a-zA-Z0-9_]*$', key):
        return False
    # camelCase: содержит хотя бы одну заглавную букву или цифру после первой
    if re.search(r'[A-Z0-9]', key[1:]):
        return True
    # Известные простые ключи
    if key in KNOWN_SIMPLE_KEYS:
        return True
    # Короткие ключи (< 4 символов) пропускаем если не в KNOWN_SIMPLE_KEYS
    if len(key) < 4 and key not in KNOWN_SIMPLE_KEYS:
        return False
    return True

def has_t_function(content: str) -> bool:
    """Проверяет, есть ли в файле функция перевода t()."""
    return bool(re.search(r'const\s+t\s*=', content) or
                re.search(r'function\s+t\s*\(', content) or
                re.search(r't:\s*\(key', content) or
                'useTranslation' in content)

def fix_tsx_raw_keys(filepath: str, dry_run: bool = True) -> List[str]:
    """Находит и исправляет {'key'} → {t('key')} в TSX файле."""
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    if not has_t_function(content):
        return []

    changes = []
    new_content = content

    # Паттерн 1: prop={'key'} — prop передаётся компоненту
    # Пример: title={'section1Title'} → title={t('section1Title')}
    # НО НЕ: aria-label={'close'}, className={'...'}, key={'...'}
    def replace_prop(match):
        attr = match.group(1)
        key = match.group(2)
        if attr in EXCLUDED_ATTRS:
            return match.group(0)
        if is_translation_key(key):
            changes.append(f"  {attr}={{'{key}'}} → {attr}={{t('{key}')}}")
            return f"{attr}={{t('{key}')}}"
        return match.group(0)

    # Находим attr={'key'}
    new_content = re.sub(
        r'(\w[\w-]*)=\{\'([a-zA-Z][a-zA-Z0-9_]*)\'\}',
        replace_prop,
        new_content
    )

    # Паттерн 2: >{'key'}< или >{'key'} (внутри JSX тега)
    # Пример: <span>{'checking'}</span> → <span>{t('checking')}</span>
    def replace_jsx_text(match):
        key = match.group(1)
        if is_translation_key(key):
            changes.append(f"  {{'{key}'}} → {{t('{key}')}}")
            return f"{{t('{key}')}}"
        return match.group(0)

    # Находим {'key'} в JSX контексте (после > или пробела/newline)
    new_content = re.sub(
        r"\{'([a-zA-Z][a-zA-Z0-9_]*)'\}",
        replace_jsx_text,
        new_content
    )

    # Паттерн 3: hardcoded строки типа 'Отрывная часть ваш' — пока не трогаем

    if changes and not dry_run:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(new_content)

    return changes


# ============================================================================
# ЧАСТЬ 2: Исправление (main).contract-data.* в contract-data.ts
# ============================================================================

CONTRACT_DATA_RU_FIXES = {
    "(main).contract-data.работа": "Работа",
    "(main).contract-data.трудовой_договор": "Трудовой договор",
    "(main).contract-data.что_должно_быть": "Что должно быть в договоре и как защитить свои права",
    "(main).contract-data.обязательные_пункты_договора": "Обязательные пункты договора",
    "(main).contract-data.по_закону_эти": "По закону эти пункты ДОЛЖНЫ быть в трудовом договоре",
    "(main).contract-data.на_что_обратить": "На что обратить внимание",
    "(main).contract-data.скрытые_условия_которые": "Скрытые условия, которые могут вам навредить",
    "(main).contract-data.красные_флаги": "Красные флаги",
    "(main).contract-data.опасные_признаки_не": "Опасные признаки — НЕ соглашайтесь на такую работу",
    "(main).contract-data.права_работника_по": "Права работника по ТК РФ",
    "(main).contract-data.эти_права_гарантированы": "Эти права гарантированы законом для ВСЕХ работников",
    "(main).contract-data.что_делать_если": "Что делать, если договор не дали",
    "(main).contract-data.куда_обращаться_и": "Куда обращаться и как себя защитить",
    "(main).contract-data.размер_заработной_платы": "Размер заработной платы",
    "(main).contract-data.точная_сумма_оклада": "Точная сумма оклада, все надбавки и премии. Не может быть ниже МРОТ (19 242₽ в 2024)",
    "(main).contract-data.график_работы": "График работы",
    "(main).contract-data.рабочие_дни_часы": "Рабочие дни, часы начала и окончания работы, выходные дни",
    "(main).contract-data.должность_и_обязанности": "Должность и обязанности",
    "(main).contract-data.название_должности_и": "Название должности и чёткий перечень ваших обязанностей",
    "(main).contract-data.срок_договора": "Срок договора",
    "(main).contract-data.бессрочный_или_срочный": "Бессрочный или срочный (с датой окончания). Срочный можно заключить только в определённых случаях",
    "(main).contract-data.место_работы": "Место работы",
    "(main).contract-data.точный_адрес_где": "Точный адрес, где вы будете работать",
    "(main).contract-data.условия_труда": "Условия труда",
    "(main).contract-data.класс_условий_труда": "Класс условий труда (оптимальные, допустимые, вредные, опасные). Гарантии и компенсации за вредные условия",
    "(main).contract-data.скрытые_штрафы": "Скрытые штрафы",
    "(main).contract-data.проверьте_раздел_о": "Проверьте раздел о штрафах. Штрафы из зарплаты за опоздания или ошибки — НЕЗАКОННЫ без вашего письменного согласия",
    "(main).contract-data.удержания_из_зарплаты": "Удержания из зарплаты",
    "(main).contract-data.закон_разрешает_удерживать": "Закон разрешает удерживать только: 13% НДФЛ, аванс (если выдан), алименты по решению суда. ВСЁ остальное — только с вашего согласия",
    "(main).contract-data.испытательный_срок": "Испытательный срок",
    "(main).contract-data.максимум_3_месяца": "Максимум 3 месяца (для руководителей — 6 месяцев). Во время испытания у вас ВСЕ права обычного сотрудника",
    "(main).contract-data.пункт_о_переработках": "Пункт о переработках",
    "(main).contract-data.переработки_должны_оплачиваться": "Переработки должны оплачиваться: первые 2 часа — x1.5, последующие — x2. Фраза «ненормированный рабочий день» не отменяет оплату переработок",
    "(main).contract-data.материальная_ответственность": "Материальная ответственность",
    "(main).contract-data.полная_материальная_ответственность": "Полная материальная ответственность возможна только для определённых должностей (кассир, кладовщик). Работодатель обязан обеспечить условия для сохранности имущества",
    "(main).contract-data.работа_без_письменного": "Работа без письменного договора",
    "(main).contract-data.устные_обещания_ничего": "Устные обещания ничего не значат. Без договора вы не сможете доказать свои права в суде",
    "(main).contract-data.забирают_документы": "Забирают документы",
    "(main).contract-data.никто_не_имеет": "Никто не имеет права забирать ваш паспорт, патент или другие документы. Это УГОЛОВНОЕ преступление",
    "(main).contract-data.устные_обещания_вместо": "Устные обещания вместо условий договора",
    "(main).contract-data.подписание_пустых_бланков": "Подписание пустых бланков",
    "(main).contract-data.никогда_не_подписывайте": "НИКОГДА не подписывайте документы, не прочитав их полностью. Особенно пустые бланки — туда могут вписать что угодно",
    "(main).contract-data.обещание_заплатить_потом": "Обещание заплатить потом",
    "(main).contract-data.зарплата_должна_выплачиваться": "Зарплата должна выплачиваться не реже 2 раз в месяц. Задержка более 15 дней — нарушение закона",
    "(main).contract-data.оплачиваемый_отпуск": "Оплачиваемый отпуск",
    "(main).contract-data.минимум_28_календарных": "Минимум 28 календарных дней в году. Право на отпуск возникает через 6 месяцев работы",
    "(main).contract-data.больничный_лист": "Больничный лист",
    "(main).contract-data.оплата_по_больничному": "Оплата по больничному из ФСС. Работодатель оплачивает первые 3 дня",
    "(main).contract-data.увольнение": "Увольнение",
    "(main).contract-data.вы_можете_уволиться": "Вы можете уволиться по собственному желанию, предупредив за 2 недели. Выходное пособие при сокращении — минимум 1 месячный оклад",
    "(main).contract-data.рабочее_время": "Рабочее время",
    "(main).contract-data.максимум_40_часов": "Максимум 40 часов в неделю. Переработки — только с вашего согласия и за дополнительную оплату",
    "(main).contract-data.безопасные_условия_труда": "Безопасные условия труда",
    "(main).contract-data.работодатель_обязан_обеспечить": "Работодатель обязан обеспечить средства защиты, обучение по охране труда и безопасные условия",
    "(main).contract-data.трудовая_инспекция": "Трудовая инспекция",
    "(main).contract-data.бесплатная_проверка_по": "Бесплатная проверка по жалобе. Горячая линия: 8-800-707-88-41",
    "(main).contract-data.прокуратура": "Прокуратура",
    "(main).contract-data.при_серьёзных_нарушениях": "При серьёзных нарушениях: невыплата зарплаты, незаконное увольнение, принудительный труд",
    "(main).contract-data.суд": "Суд",
    "(main).contract-data.можно_подать_иск": "Можно подать иск самостоятельно. Госпошлина по трудовым спорам НЕ взимается",
    "(main).contract-data.посольство_вашей_страны": "Посольство вашей страны",
    "(main).contract-data.консультация_и_помощь": "Консультация и помощь в сложных ситуациях. Могут обратиться к российским органам",
    "(main).contract-data.собирайте_доказательства": "Собирайте доказательства",
    "(main).contract-data.фотографируйте_рабочее_место": "Фотографируйте рабочее место, сохраняйте переписки, записывайте разговоры. Найдите свидетелей среди коллег",
    "(main).contract-data.важное_предупреждение": "Важное предупреждение",
    "(main).contract-data.иностранные_работники_имеют": "Иностранные работники имеют ВСЕ права по ТК РФ наравне с гражданами России. Не соглашайтесь на условия хуже, чем требует закон!",
    # Таджикский
    "(main).contract-data.кор": "Кор",
    "(main).contract-data.шартномаи_менат": "Шартномаи меҳнатӣ",
    "(main).contract-data.дар_шартнома_ч": "Дар шартнома чӣ бояд бошад ва чӣ тавр ҳуқуқи худро ҳимоя кардан",
    "(main).contract-data.бандои_атмии_шартнома": "Бандҳои ҳатмии шартнома",
    "(main).contract-data.мувофии_онун_ин": "Мувофиқи қонун ин бандҳо БОЯД дар шартномаи меҳнатӣ бошанд",
    "(main).contract-data.ба_ч_диат": "Ба чӣ диққат додан лозим",
    "(main).contract-data.шартои_пиноние_ки": "Шартҳои пинҳонии, ки метавонанд ба шумо зарар расонанд",
    "(main).contract-data.байраои_сурх": "Байроқҳои сурх",
    "(main).contract-data.аломатои_хатарнок_ба": "Аломатҳои хатарнок — ба чунин кор РОЗӢ НАШАВЕД",
    "(main).contract-data.ууои_коргар_мувофии": "Ҳуқуқҳои коргар мувофиқи КМ",
    "(main).contract-data.ин_ууо_барои": "Ин ҳуқуқҳо барои ҲАМАИ коргарон бо қонун кафолат дода шудааст",
    "(main).contract-data.ч_кор_кардан": "Чӣ кор кардан, агар шартнома надоданд",
    "(main).contract-data.ба_куо_муроиат": "Ба куҷо муроҷиат кардан ва чӣ тавр худро ҳимоя кардан",
    "(main).contract-data.андозаи_маош": "Андозаи маош",
    "(main).contract-data.маблаи_даии_маош": "Маблағи дақиқи маош, ҳамаи иловагиҳо ва мукофотҳо. Аз ҲХИМ паст буда наметавонад",
    "(main).contract-data.адвали_кор": "Ҷадвали кор",
    "(main).contract-data.рзои_кор_соатои": "Рӯзҳои корӣ, соатҳои оғоз ва хотимаи кор, рӯзҳои истироҳат",
    "(main).contract-data.вазифа_ва_дадорио": "Вазифа ва ӯҳдадориҳо",
    "(main).contract-data.номи_вазифа_ва": "Номи вазифа ва рӯйхати равшани ӯҳдадориҳои шумо",
    "(main).contract-data.млати_шартнома": "Мӯҳлати шартнома",
    "(main).contract-data.бемлат_млатнок_бо": "Бемӯҳлат ё мӯҳлатнок (бо санаи хотима). Мӯҳлатнок танҳо дар ҳолатҳои муайян баста мешавад",
    "(main).contract-data.ои_кор": "Ҷойи кор",
    "(main).contract-data.суроаи_даи_ки": "Суроғаи дақиқи, ки шумо кор хоҳед кард",
    "(main).contract-data.шароити_менат": "Шароити меҳнат",
    "(main).contract-data.синфи_шароити_менат": "Синфи шароити меҳнат (оптималӣ, қобилпазир, зараровар, хатарнок). Кафолатҳо ва ҷуброн барои шароити зараровар",
    "(main).contract-data.аримаои_пинон": "Ҷаримаҳои пинҳон",
    "(main).contract-data.бахши_аримаоро_санед": "Бахши ҷаримаҳоро санҷед. Ҷаримаҳо аз маош барои дер омадан ё хатоҳо — ҒАЙРИҚОНУНӢ бе розигии хаттии шумо",
    "(main).contract-data.нигодорио_аз_маош": "Нигоҳдориҳо аз маош",
    "(main).contract-data.онун_тано_ниго": "Қонун танҳо нигоҳ доштанро иҷозат медиҳад: 13% АХДМ, пешпардохт (агар дода шуда бошад), алименти суд. ҲАМАИ боқимонда — танҳо бо розигии шумо",
    "(main).contract-data.млати_саниш": "Мӯҳлати санҷиш",
    "(main).contract-data.адди_аксар_3": "Ҳадди аксар 3 моҳ (барои роҳбарон — 6 моҳ). Дар вақти санҷиш шумо ҲАМАИ ҳуқуқҳои кормандони муқаррариро доред",
    "(main).contract-data.банд_дар_бораи": "Банд дар бораи кори изофагӣ",
    "(main).contract-data.кори_изофаг_бояд": "Кори изофагӣ бояд пардохт шавад: 2 соати аввал — x1.5, баъдӣ — x2. Ибораи «рӯзи кории ғайримеъёрӣ» пардохти кори изофагиро бекор намекунад",
    "(main).contract-data.масъулияти_модд": "Масъулияти моддӣ",
    "(main).contract-data.масъулияти_пурраи_модд": "Масъулияти пурраи моддӣ танҳо барои вазифаҳои муайян имконпазир аст (кассир, анборчӣ). Корфармо бояд шароит барои нигоҳдории амволро таъмин кунад",
    "(main).contract-data.кор_бе_шартномаи": "Кор бе шартномаи хаттӣ",
    "(main).contract-data.ваъдаои_даон_маъние": "Ваъдаҳои даҳонӣ маънии ҳеҷ чизро надоранд. Бе шартнома шумо ҳуқуқҳои худро дар суд исбот карда наметавонед",
    "(main).contract-data.мусодираи_уато": "Мусодираи ҳуҷҷатҳо",
    "(main).contract-data.е_кас_уу": "Ҳеҷ кас ҳуқуқ надорад шиноснома, патент ё дигар ҳуҷҷатҳои шуморо гирад. Ин ҶИНОЯТИ ҶИНОЯТӢ аст",
    "(main).contract-data.ваъдаои_даон_ба": "Ваъдаҳои даҳонӣ ба ҷойи шартҳои шартнома",
    "(main).contract-data.имзо_кардани_бланкаои": "Имзо кардани бланкаҳои холӣ",
    "(main).contract-data.е_гое_уаторо": "ҲЕҶ ГОҲЕ ҳуҷҷатҳоро бе хондани пурра имзо накунед. Махсусан бланкаҳои холиро — ба онҳо чизи дилхоҳро навишта метавонанд",
    "(main).contract-data.ваъдаи_пардохт_баъдтар": "Ваъдаи пардохт «баъдтар»",
    "(main).contract-data.маош_бояд_на": "Маош бояд на камтар аз 2 маротиба дар моҳ пардохт шавад. Таъхир зиёда аз 15 рӯз — вайронкунии қонун",
    "(main).contract-data.рухсатии_пулак": "Рухсатии пулакӣ",
    "(main).contract-data.адди_аал_28": "Ҳадди ақал 28 рӯзи тақвимӣ дар сол. Ҳуқуқи рухсатӣ пас аз 6 моҳи кор пайдо мешавад",
    "(main).contract-data.варааи_бемории": "Варақаи беморӣ",
    "(main).contract-data.пардохти_варааи_бемории": "Пардохти варақаи беморӣ аз ФСИ. Корфармо 3 рӯзи аввалро пардохт мекунад",
    "(main).contract-data.аз_кор_озод": "Аз кор озод кардан",
    "(main).contract-data.шумо_метавонед_бо": "Шумо метавонед бо хоҳиши худ, 2 ҳафта пеш огоҳ карда, аз кор равед. Кӯмакпулии ҳангоми кисқартиш — ҳадди ақал 1 маоши моҳона",
    "(main).contract-data.вати_кор": "Вақти кор",
    "(main).contract-data.адди_аксар_40": "Ҳадди аксар 40 соат дар ҳафта. Кори изофагӣ — танҳо бо розигии шумо ва барои пардохти иловагӣ",
    "(main).contract-data.шароити_бехатари_менат": "Шароити бехатарии меҳнат",
    "(main).contract-data.корфармо_бояд_воситаои": "Корфармо бояд воситаҳои ҳимоя, омӯзиш оид ба ҳифзи меҳнат ва шароити бехатарро таъмин кунад",
    "(main).contract-data.инспексияи_менат": "Инспексияи меҳнат",
    "(main).contract-data.саниши_ройгон_аз": "Санҷиши ройгон аз рӯйи шикоят. Хатти телефонӣ: 8-800-707-88-41",
    "(main).contract-data.прокуратура": "Прокуратура",
    "(main).contract-data.ангоми_вайронкуниои_идд": "Ҳангоми вайронкуниҳои ҷиддӣ: напардохтани маош, аз кор озодкунии ғайриқонунӣ, меҳнати маҷбурӣ",
    "(main).contract-data.суд": "Суд",
    "(main).contract-data.шумо_метавонед_худатон": "Шумо метавонед худатон даъво пешниҳод кунед. Боҷи давлатӣ барои баҳсҳои меҳнатӣ гирифта НАМЕШАВАД",
    "(main).contract-data.сафоратхонаи_мамлакати_шумо": "Сафоратхонаи мамлакати шумо",
    "(main).contract-data.машварат_ва_кмак": "Машварат ва кӯмак дар вазъиятҳои мушкил. Метавонанд ба мақомоти Россия муроҷиат кунанд",
    "(main).contract-data.далело_амъ_кунед": "Далелҳо ҷамъ кунед",
    "(main).contract-data.ои_корро_акс": "Ҷойи корро акс гиред, мукотиботро нигоҳ доред, сӯҳбатҳоро сабт кунед. Аз байни ҳамкорон шоҳидон ёбед",
    "(main).contract-data.огоии_муим": "Огоҳии муҳим",
    "(main).contract-data.коргарони_хори_амаи": "Коргарони хориҷӣ ҲАМАИ ҳуқуқҳоро мувофиқи КМ ФР баробари шаҳрвандони Россия доранд. Ба шартҳои бадтар аз талаботи қонун розӣ нашавед!",
    # Кыргызский
    "(main).contract-data.жумуш": "Жумуш",
    "(main).contract-data.эмгек_келишими": "Эмгек келишими",
    "(main).contract-data.келишимде_эмне_болушу": "Келишимде эмне болушу керек жана укуктарыңызды кантип коргоо",
    "(main).contract-data.келишимдин_милдетт_пункттары": "Келишимдин милдеттүү пункттары",
    "(main).contract-data.мыйзам_боюнча_бул": "Мыйзам боюнча бул пункттар эмгек келишиминде БОЛУШУ КЕРЕК",
    "(main).contract-data.эмнеге_кл_буруу": "Эмнеге көл буруу керек",
    "(main).contract-data.зыян_келтириши_ммкн": "Зыян келтириши мүмкүн болгон жашыруун шарттар",
    "(main).contract-data.кызыл_желектер": "Кызыл желектер",
    "(main).contract-data.коркунучтуу_белгилер_мындай": "Коркунучтуу белгилер — мындай жумушка МАКУЛ БОЛБОҢУЗ",
    "(main).contract-data.эмгек_кодекси_боюнча": "Эмгек кодекси боюнча жумушчунун укуктары",
    "(main).contract-data.бул_укуктар_бардык": "Бул укуктар БАРДЫК жумушчулар үчүн мыйзам менен кепилденген",
    "(main).contract-data.келишим_берилбесе_эмне": "Келишим берилбесе эмне кылуу керек",
    "(main).contract-data.кайда_кайрылуу_жана": "Кайда кайрылуу жана өзүңүздү кантип коргоо",
    "(main).contract-data.айлык_акынын_лчм": "Айлык акынын өлчөмү",
    "(main).contract-data.айлыктын_так_суммасы": "Айлыктын так суммасы, бардык кошумча акылар жана сыйлыктар. МЕАКтан төмөн болушу мүмкүн эмес",
    "(main).contract-data.жумуш_графиги": "Жумуш графиги",
    "(main).contract-data.жумуш_кндр_жумуштун": "Жумуш күндөрү, жумуштун башталышы жана аякташы, дем алыш күндөрү",
    "(main).contract-data.кызмат_орду_жана": "Кызмат орду жана милдеттер",
    "(main).contract-data.кызмат_ордунун_аталышы": "Кызмат ордунун аталышы жана милдеттериңиздин так тизмеси",
    "(main).contract-data.келишимдин_мнт": "Келишимдин мөөнөтү",
    "(main).contract-data.мнтсз_же_мнтт": "Мөөнөтсүз же мөөнөттүү (аяктоо датасы менен). Мөөнөттүүнү белгилүү учурларда гана түзсө болот",
    "(main).contract-data.жумуш_орду": "Жумуш орду",
    "(main).contract-data.иштей_турган_так": "Иштей турган так дарегиңиз",
    "(main).contract-data.эмгек_шарттары": "Эмгек шарттары",
    "(main).contract-data.эмгек_шарттарынын_классы": "Эмгек шарттарынын классы (оптималдуу, жол берилүүчү, зыяндуу, коркунучтуу). Зыяндуу шарттар үчүн кепилдиктер жана компенсациялар",
    "(main).contract-data.жашыруун_айыптар": "Жашыруун айыптар",
    "(main).contract-data.айып_блмн_текшерииз": "Айып бөлүмүн текшериңиз. Кечигүү же каталар үчүн айлыктан кармоо — жазуу макулдугуңуз жок болсо МЫЙЗАМСЫЗ",
    "(main).contract-data.айлыктан_кармоолор": "Айлыктан кармоолор",
    "(main).contract-data.мыйзам_кармоого_уруксат": "Мыйзам кармоого уруксат берет: 13% ЖСУК, аванс (берилсе), сот чечими менен алименттер. КАЛГАН БААРЫ — макулдугуңуз менен гана",
    "(main).contract-data.сыноо_мнт": "Сыноо мөөнөтү",
    "(main).contract-data.максимум_3_ай": "Максимум 3 ай (жетекчилер үчүн — 6 ай). Сыноо учурунда сизде кадимки кызматкердин БАРДЫК укуктары бар",
    "(main).contract-data.ашыкча_иш_жннд": "Ашыкча иш жөнүндө пункт",
    "(main).contract-data.жазуу_трндг_келишимсиз": "Жазуу түрүндөгү келишимсиз иштөө",
    "(main).contract-data.оозеки_убадалар_эч": "Оозеки убадалар эч нерсе билдирбейт. Келишимсиз сиз сотто укуктарыңызды далилдей албайсыз",
    "(main).contract-data.документтерди_тартып_алуу": "Документтерди тартып алуу",
    "(main).contract-data.эч_кимдин_паспортуузду": "Эч кимдин паспортуңузду, патентиңизди же башка документтериңизди алууга укугу жок. Бул КЫЛМЫШ иши",
    "(main).contract-data.келишимдеги_жазуунун_ордуна": "Келишимдеги жазуунун ордуна оозеки убадалар",
    "(main).contract-data.бош_бланктарга_кол": "Бош бланктарга кол коюу",
    "(main).contract-data.документтерди_толук_окубастан": "Документтерди толук окубастан ЭЧ КАЧАН кол койбоңуз. Өзгөчө бош бланктарга — аларга каалаганын жазышы мүмкүн",
    "(main).contract-data.айлык_айына_кеминде": "Айлык айына кеминде 2 жолу төлөнүшү керек. 15 күндөн ашык кечиктирүү — мыйзам бузуу",
    "(main).contract-data.акылуу_рг": "Акылуу өргүү",
    "(main).contract-data.жылына_кеминде_28": "Жылына кеминде 28 календардык күн. Өргүүгө укук 6 ай иштегенден кийин пайда болот",
    "(main).contract-data.оорулуу_баракчасы": "Оорулуу баракчасы",
    "(main).contract-data.оорулуу_баракчасы_сфсдин": "Оорулуу баракчасы СФСдин эсебинен. Иш берүүчү биринчи 3 күндү төлөйт",
    "(main).contract-data.иштен_бошотуу": "Иштен бошотуу",
    "(main).contract-data.з_каалооуз_менен": "Өз каалооңуз менен 2 жума мурун эскертип иштен кете аласыз. Кыскартууда жөлөк пул — кеминде 1 айлык",
    "(main).contract-data.жумуш_убактысы": "Жумуш убактысы",
    "(main).contract-data.жумасына_максимум_40": "Жумасына максимум 40 саат. Ашыкча иш — макулдугуңуз менен жана кошумча акы үчүн гана",
    "(main).contract-data.коопсуз_эмгек_шарттары": "Коопсуз эмгек шарттары",
    "(main).contract-data.иш_берч_коргоо": "Иш берүүчү коргоо каражаттарын, эмгек коопсуздугу боюнча окутууну жана коопсуз шарттарды камсыз кылууга милдеттүү",
    "(main).contract-data.эмгек_инспекциясы": "Эмгек инспекциясы",
    "(main).contract-data.арыз_боюнча_акысыз": "Арыз боюнча акысыз текшерүү. Ишеним телефону: 8-800-707-88-41",
    "(main).contract-data.прокуратура": "Прокуратура",
    "(main).contract-data.олуттуу_бузуулар_чн": "Олуттуу бузуулар үчүн: айлык төлөбөө, мыйзамсыз бошотуу, мажбурлоо менен иштетүү",
    "(main).contract-data.сот": "Сот",
    "(main).contract-data.арызды_зз_бере": "Арызды өзүңүз бере аласыз. Эмгек талаштары боюнча мамлекеттик салык АЛЫНБАЙТ",
    "(main).contract-data.лкздн_элчилиги": "Өлкөңүздүн элчилиги",
    "(main).contract-data.татаал_кырдаалдарда_консультация": "Татаал кырдаалдарда консультация жана жардам. Россиянын органдарына кайрыла алышат",
    "(main).contract-data.далилдерди_чогултууз": "Далилдерди чогултуңуз",
    "(main).contract-data.жумуш_ордун_сртк": "Жумуш ордун сүрөткө тартыңыз, кат алышууларды сактаңыз, сүйлөшүүлөрдү жазып алыңыз. Кесиптештериңиздин арасынан күбөлөрдү табыңыз",
    "(main).contract-data.маанил_эскерт": "Маанилүү эскертүү",
    "(main).contract-data.чет_элдик_жумушчулар": "Чет элдик жумушчулар РФнын ЭК боюнча Россия жарандары менен БИР КАЛЫПТА БАРДЫК укуктарга ээ. Мыйзам талап кылгандан начарыраак шарттарга макул болбоңуз!",
}

def fix_contract_data(filepath: str, dry_run: bool = True) -> List[str]:
    """Исправляет (main).contract-data.* ключи в contract-data.ts."""
    with open(filepath, 'r', encoding='utf-8') as f:
        content = f.read()

    changes = []
    new_content = content

    for old_key, new_value in CONTRACT_DATA_RU_FIXES.items():
        if old_key in new_content:
            # Экранируем скобки для замены
            escaped_old = old_key.replace('(', r'\(').replace(')', r'\)').replace('.', r'\.')
            # Заменяем в строковых литералах: '(main).contract-data.xxx' → 'Правильный текст'
            pattern = f"'{re.escape(old_key)}'"
            replacement = f"'{new_value}'"
            if pattern.replace('\\', '') in new_content:
                new_content = new_content.replace(f"'{old_key}'", f"'{new_value}'")
                changes.append(f"  '{old_key}' → '{new_value[:50]}...'")

    # Также ищем оставшиеся (main).contract-data.* и распаковываем из ключа
    remaining = re.findall(r"'(\(main\)\.contract-data\.[^']+)'", new_content)
    for key in remaining:
        # Извлекаем текст из ключа: (main).contract-data.xxx_yyy → Xxx yyy
        text_part = key.replace('(main).contract-data.', '')
        text = text_part.replace('_', ' ').strip()
        if text:
            text = text[0].upper() + text[1:]
            new_content = new_content.replace(f"'{key}'", f"'{text}'")
            changes.append(f"  '{key}' → '{text}' (авто)")

    if changes and not dry_run:
        with open(filepath, 'w', encoding='utf-8') as f:
            f.write(new_content)

    return changes


# ============================================================================
# ЧАСТЬ 3: Исправление обрезанных русских переводов в labels
# ============================================================================

TRUNCATED_RU_FIXES = {
    # registration-guide/labels.ts
    "apps/frontend/src/components/housing/registration-guide/labels.ts": {
        "'Миграционный учт'": "'Миграционный учёт'",
        "'Что такое миграционный'": "'Что такое миграционный учёт'",
        "'Как встать на'": "'Как встать на учёт'",
        "'Вариант а арендодатель'": "'Вариант А: Арендодатель делает сам (рекомендуется)'",
        "'Вариант б через'": "'Вариант Б: Через МФЦ с арендодателем'",
        "'Вариант в через'": "'Вариант В: Через Почту России'",
        "'Вариант г через'": "'Вариант Г: Через Госуслуги (для арендодателя)'",
        "'Чего не делать'": "'Чего НЕ делать'",
        "'Никогда не покупайте'": "'НИКОГДА не покупайте регистрацию'",
        "'Не пропускайте сроки'": "'Не пропускайте сроки регистрации'",
        "'Каждый день просрочки'": "'Каждый день просрочки = риск штрафа и депортации'",
        "'Не выбрасывайте отрывную'": "'Не выбрасывайте отрывную часть'",
        "'Это ваш единственный'": "'Это ваш ЕДИНСТВЕННЫЙ документ о регистрации. Храните его с паспортом.'",
        "'Не регистрируйтесь по'": "'Не регистрируйтесь по адресу, где не живёте'",
        "'Проверки мвд реальны'": "'Проверки МВД реальны. При обнаружении — штраф + запрет въезда.'",
        "'Не оставайтесь без'": "'Не оставайтесь без регистрации после смены жилья'",
        "'При переезде 7'": "'При переезде: 7 дней на новую регистрацию.'",
        "'Штрафы и риски'": "'Штрафы и риски'",
        "'Просрочка регистрации'": "'Просрочка регистрации'",
        "'Просрочка в москвеспб'": "'Просрочка в Москве/СПб'",
        "'До 500 000'": "'До 500 000 ₽ + уголовное дело'",
        "'Запрет на въезд'": "'Запрет на въезд'",
        "'Права арендатора'": "'Права арендатора'",
        "'Вы имеете право'": "'Вы имеете право требовать:'",
        "'Бесплатную регистрацию госпошлины'": "'Бесплатную регистрацию (госпошлины НЕТ!)'",
        "'Отрывную часть уведомления'": "'Отрывную часть уведомления на руки'",
        "'Регистрацию в течение'": "'Регистрацию в течение 7 дней'",
        "'Регистрацию по реальному'": "'Регистрацию по реальному адресу проживания'",
        "'Арендодатель обязан'": "'Арендодатель ОБЯЗАН:'",
        "'Подать уведомление о'": "'Подать уведомление о прибытии'",
        "'Не брать деньги'": "'Не брать деньги за регистрацию (это бесплатно)'",
        "'Предоставить документы на'": "'Предоставить документы на жильё'",
        "'Если арендодатель отказывает'": "'Если арендодатель отказывает в регистрации:'",
        "'Это нарушение закона'": "'Это нарушение закона (КоАП, ст. 18.9)'",
        "'Штраф арендодателю 2'": "'Штраф арендодателю: 2 000 - 4 000 ₽'",
        "'Вы можете пожаловаться'": "'Вы можете пожаловаться в МВД'",
        "'Рассмотрите смену жилья'": "'Рассмотрите смену жилья — жить без регистрации опасно'",
        "'Мвд по вопросам'": "'МВД по вопросам миграции: 8-800-222-74-47'",
        "'Прокуратура при отказе'": "'Прокуратура — при отказе в регистрации'",
        "'Регистрация прописка регистрация'": "'Регистрация ≠ прописка (регистрация временная, не даёт прав на жильё)'",
        "'Вы можете быть'": "'Вы можете быть зарегистрированы только по одному адресу'",
        "'При выезде из'": "'При выезде из России регистрация автоматически аннулируется'",
        "'При продлении визыпатента'": "'При продлении визы/патента — продлите регистрацию'",
    },
    # tenant-rights/labels.ts
    "apps/frontend/src/components/housing/tenant-rights/labels.ts": {
        "'Согласно гражданскому кодексу'": "'Согласно Гражданскому кодексу РФ (глава 35), как арендатор вы имеете следующие права:'",
        "'Проживать в арендованном'": "'Проживать в арендованном жилье весь срок договора'",
        "'Вселять членов семьи'": "'Вселять членов семьи без согласия арендодателя'",
        "'Требовать устранения недостатков'": "'Требовать устранения недостатков жилья'",
        "'Пользоваться общедомовым имуществом'": "'Пользоваться общедомовым имуществом'",
        "'Получить письменное уведомление'": "'Получить письменное уведомление о расторжении за 3 месяца'",
        "'Преимущественное право на'": "'Преимущественное право на продление договора'",
        "'Права по договору'": "'Права по договору'",
        "'Договор аренды обязан'": "'Договор аренды ОБЯЗАН содержать:'",
        "'Полные данные сторон'": "'Полные данные сторон (ФИО, паспорт, адрес)'",
        "'Точный адрес и'": "'Точный адрес и описание жилья'",
        "'Размер арендной платы'": "'Размер арендной платы и порядок оплаты'",
        "'Условия расторжения договора'": "'Условия расторжения договора'",
        "'Права и обязанности'": "'Права и обязанности сторон'",
        "'Копию договора на'": "'Копию договора на руки'",
        "'Акт примапередачи с'": "'Акт приёма-передачи с описью имущества'",
        "'Расписку о получении'": "'Расписку о получении залога'",
        "'Права при оплате'": "'Права при оплате'",
        "'Права на условия'": "'Права на условия проживания'",
        "'Ремонт и обслуживание'": "'Ремонт и обслуживание'",
        "'Доступ в квартиру'": "'Доступ в квартиру'",
        "'Защита от выселения'": "'Защита от выселения'",
        "'Арендодатель не может'": "'Арендодатель НЕ МОЖЕТ выселить вас без причины. Законные основания для выселения:'",
        "'Неоплата аренды более'": "'Неоплата аренды более 2 месяцев подряд'",
        "'Систематическое нарушение прав'": "'Систематическое нарушение прав соседей'",
        "'Порча имущества или'": "'Порча имущества или использование не по назначению'",
        "'Истечение срока договора'": "'Истечение срока договора (с уведомлением за 3 месяца)'",
        "'Права при расторжении'": "'Права при расторжении'",
        "'Если вы хотите'": "'Если ВЫ хотите съехать'",
        "'Если арендодатель хочет'": "'Если арендодатель хочет расторгнуть'",
        "'Куда обращаться за'": "'Куда обращаться за помощью'",
        "'Если ваши права'": "'Если ваши права нарушены:'",
        "'При угрозах насилии'": "'При угрозах, насилии, незаконном выселении'",
        "'При систематических нарушениях'": "'При систематических нарушениях ваших прав'",
        "'При ненадлежащих условиях'": "'При ненадлежащих условиях проживания (антисанитария)'",
        "'Для возврата залога'": "'Для возврата залога, компенсации ущерба'",
        "'Центры бесплатной юридической'": "'Центры бесплатной юридической помощи при адвокатских палатах'",
        "'Горячая линия мвд'": "'Горячая линия МВД по миграции: 8-800-222-74-47 (бесплатно)'",
        "'Всегда заключайте письменный'": "'Всегда заключайте письменный договор (устный договор = нет защиты)'",
        "'Делайте фото квартиры'": "'Делайте фото квартиры при заселении и выезде'",
        "'Сохраняйте все переписки'": "'Сохраняйте ВСЕ переписки с арендодателем'",
        "'Не платите наличными'": "'Не платите наличными без расписки'",
        "'Проверяйте арендодателя перед'": "'Проверяйте арендодателя перед заселением'",
        "'Не соглашайтесь на'": "'Не соглашайтесь на «серую» аренду без договора'",
        "'Гражданский кодекс рф'": "'Гражданский кодекс РФ, глава 35 «Наём жилого помещения»'",
        "'Жилищный кодекс рф'": "'Жилищный кодекс РФ, раздел VII «Плата за жильё и коммунальные услуги»'",
        "'Закон рф от'": "'Закон РФ от 07.02.1992 № 2300-1 «О защите прав потребителей»'",
    },
}

def fix_truncated_translations(dry_run: bool = True) -> Dict[str, List[str]]:
    """Исправляет обрезанные русские переводы в labels файлах."""
    all_changes = {}

    for rel_path, fixes in TRUNCATED_RU_FIXES.items():
        filepath = str(BASE_DIR.parent.parent.parent / rel_path)
        if not os.path.exists(filepath):
            continue

        with open(filepath, 'r', encoding='utf-8') as f:
            content = f.read()

        changes = []
        new_content = content

        for old_val, new_val in fixes.items():
            if old_val in new_content:
                new_content = new_content.replace(old_val, new_val)
                changes.append(f"  {old_val} → {new_val}")

        if changes:
            all_changes[rel_path] = changes
            if not dry_run:
                with open(filepath, 'w', encoding='utf-8') as f:
                    f.write(new_content)

    return all_changes


# ============================================================================
# ОСНОВНАЯ ЛОГИКА
# ============================================================================

def find_tsx_files_with_issues() -> List[str]:
    """Находит все TSX файлы с потенциальными проблемами."""
    files = []
    for root, _, filenames in os.walk(str(BASE_DIR)):
        for filename in filenames:
            if filename.endswith('.tsx') or filename.endswith('.ts'):
                filepath = os.path.join(root, filename)
                with open(filepath, 'r', encoding='utf-8') as f:
                    content = f.read()
                # Ищем паттерн {'camelCaseKey'} в файлах с функцией t()
                if has_t_function(content):
                    if re.search(r"\{'[a-zA-Z][a-zA-Z0-9_]+'\}", content):
                        files.append(filepath)
    return files


def main():
    import argparse
    parser = argparse.ArgumentParser(description='Исправление ошибок i18n в компонентах')
    parser.add_argument('--check', action='store_true', help='Показать проблемы (без исправления)')
    parser.add_argument('--fix', action='store_true', help='Исправить все проблемы')
    args = parser.parse_args()

    if not args.check and not args.fix:
        parser.print_help()
        return

    dry_run = not args.fix
    total_fixes = 0
    total_files = 0

    print("=" * 70)
    print("ЧАСТЬ 1: Замена {'key'} → {t('key')} в TSX файлах")
    print("=" * 70)

    tsx_files = find_tsx_files_with_issues()
    for filepath in sorted(tsx_files):
        rel_path = os.path.relpath(filepath, str(BASE_DIR.parent.parent.parent))
        changes = fix_tsx_raw_keys(filepath, dry_run)
        if changes:
            total_files += 1
            total_fixes += len(changes)
            print(f"\n📄 {rel_path} ({len(changes)} замен):")
            for c in changes[:10]:  # Показываем первые 10
                print(c)
            if len(changes) > 10:
                print(f"  ... и ещё {len(changes) - 10}")

    print(f"\nИтого Часть 1: {total_fixes} замен в {total_files} файлах")

    print("\n" + "=" * 70)
    print("ЧАСТЬ 2: Исправление (main).contract-data.* в contract-data.ts")
    print("=" * 70)

    contract_data_path = str(BASE_DIR / "app" / "(main)" / "work" / "contract" / "components" / "contract-data.ts")
    if os.path.exists(contract_data_path):
        changes = fix_contract_data(contract_data_path, dry_run)
        if changes:
            total_fixes += len(changes)
            total_files += 1
            print(f"\n📄 contract-data.ts ({len(changes)} замен):")
            for c in changes[:15]:
                print(c)
            if len(changes) > 15:
                print(f"  ... и ещё {len(changes) - 15}")
    else:
        print(f"  ⚠️ Файл не найден: {contract_data_path}")

    print("\n" + "=" * 70)
    print("ЧАСТЬ 3: Исправление обрезанных русских переводов")
    print("=" * 70)

    truncated_changes = fix_truncated_translations(dry_run)
    for filepath, changes in truncated_changes.items():
        total_files += 1
        total_fixes += len(changes)
        print(f"\n📄 {filepath} ({len(changes)} замен):")
        for c in changes[:10]:
            print(c)
        if len(changes) > 10:
            print(f"  ... и ещё {len(changes) - 10}")

    print("\n" + "=" * 70)
    action = "ИСПРАВЛЕНО" if args.fix else "НАЙДЕНО (--fix для исправления)"
    print(f"ИТОГО: {total_fixes} проблем {action} в {total_files} файлах")
    print("=" * 70)


if __name__ == '__main__':
    main()
