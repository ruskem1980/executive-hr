#!/bin/bash
# ============================================================
# ExecVision AI ‚Äî –°—Ç–∞—Ä—Ç –¥–µ–º–æ-—Å—Ç–µ–Ω–¥–∞
# ============================================================
# –ó–∞–ø—É—Å–∫–∞–µ—Ç TTS —Å–µ—Ä–≤–µ—Ä (–Ø–Ω–¥–µ–∫—Å SpeechKit –ø—Ä–æ–∫—Å–∏) + –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç
# –¥–µ–º–æ-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ.
#
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
#   bash scripts/start_demo.sh
# ============================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT="$(dirname "$SCRIPT_DIR")"
DEMO="$ROOT/src/web/demo/index.html"
TTS_PID_FILE="$ROOT/.tts_server.pid"

echo ""
echo "  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "  ‚ïë   ExecVision AI ‚Äî Demo Launcher          ‚ïë"
echo "  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""

# --- 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º .env ---
if [ ! -f "$ROOT/.env" ]; then
  echo "  ‚úó –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω. –ì–æ–ª–æ—Å –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä (Web Speech API)."
else
  echo "  ‚úì .env –Ω–∞–π–¥–µ–Ω"
fi

# --- 2. –ó–∞–ø—É—Å–∫–∞–µ–º TTS —Å–µ—Ä–≤–µ—Ä ---
echo "  ‚è≥ –ó–∞–ø—É—Å–∫–∞–µ–º TTS —Å–µ—Ä–≤–µ—Ä –Ω–∞ –ø–æ—Ä—Ç—É 8081..."

# –£–±–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π –ø—Ä–æ—Ü–µ—Å—Å –µ—Å–ª–∏ –µ—Å—Ç—å
if [ -f "$TTS_PID_FILE" ]; then
  OLD_PID=$(cat "$TTS_PID_FILE")
  kill "$OLD_PID" 2>/dev/null
  rm -f "$TTS_PID_FILE"
fi

cd "$ROOT"
python3 src/web/tts_server.py &> /tmp/tts_server.log &
TTS_PID=$!
echo $TTS_PID > "$TTS_PID_FILE"

# –ñ–¥—ë–º —Å—Ç–∞—Ä—Ç–∞ (–º–∞–∫—Å 5 —Å–µ–∫)
for i in {1..10}; do
  sleep 0.5
  if curl -s http://localhost:8081/health > /dev/null 2>&1; then
    echo "  ‚úì TTS —Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω (PID $TTS_PID)"
    break
  fi
  if [ $i -eq 10 ]; then
    echo "  ‚ö† TTS —Å–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—Ç–∏–ª ‚Äî –¥–µ–º–æ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –±–µ–∑ –≥–æ–ª–æ—Å–∞ (Web Speech API fallback)"
  fi
done

# --- 3. –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ–º–æ ---
echo "  üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º –¥–µ–º–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ..."
if command -v open &> /dev/null; then
  open "$DEMO"
elif command -v xdg-open &> /dev/null; then
  xdg-open "$DEMO"
else
  echo "  –û—Ç–∫—Ä–æ–π –≤—Ä—É—á–Ω—É—é: $DEMO"
fi

echo ""
echo "  ‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
echo "  ‚ïë  –î–µ–º–æ –∑–∞–ø—É—â–µ–Ω–æ!                          ‚ïë"
echo "  ‚ïë  TTS: http://localhost:8081              ‚ïë"
echo "  ‚ïë  –õ–æ–≥: /tmp/tts_server.log               ‚ïë"
echo "  ‚ïë  –°—Ç–æ–ø: bash scripts/stop_demo.sh        ‚ïë"
echo "  ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
echo ""
echo "  –ù–∞–∂–º–∏ Ctrl+C –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è..."
trap "kill $TTS_PID 2>/dev/null; rm -f $TTS_PID_FILE; echo '  TTS —Å–µ—Ä–≤–µ—Ä –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.'; exit 0" INT
wait $TTS_PID
