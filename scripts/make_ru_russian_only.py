#!/usr/bin/env python3
"""
–£–º–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ ru.json - –æ—Å—Ç–∞–≤–ª—è–µ—Ç —Ç–æ–ª—å–∫–æ —Ä—É—Å—Å–∫–∏–π —è–∑—ã–∫.
–£–¥–∞–ª—è–µ—Ç —Ç–∞–¥–∂–∏–∫—Å–∫–∏–π, –∫–∏—Ä–≥–∏–∑—Å–∫–∏–π, —É–∑–±–µ–∫—Å–∫–∏–π –∏—Å–ø–æ–ª—å–∑—É—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—É—é –ª–æ–≥–∏–∫—É.
"""
import json
import re
from pathlib import Path
from typing import Any, Set
import shutil

PROJECT_ROOT = Path.cwd()
LOCALES_DIR = PROJECT_ROOT / "apps" / "frontend" / "src" / "locales"

# –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –¥–ª—è –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —è–∑—ã–∫–æ–≤
TAJIK_CHARS = set('”£”Ø“≥“∑“õ“ì')
KYRGYZ_CHARS = set('”©“Ø“£')

# –¢–æ–ø-200 —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤ –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
RUSSIAN_WORDS = {
    '–≤', '–∏', '–Ω–µ', '–Ω–∞', '—è', '—Å', '—á—Ç–æ', '–∞', '–ø–æ', '—ç—Ç–æ', '–∫–∞–∫', '–µ–≥–æ',
    '–∫', '–æ–Ω', '–¥–ª—è', '–∏–∑', '–æ—Ç', '–∂–µ', '–∑–∞', '–≤—ã', '—Ç–∞–∫', '–Ω–æ', '–±—ã—Ç—å',
    '–æ', '—É', '–∏–ª–∏', '–µ—â–µ', '–±—ã–ª–æ', '–±—ã', '–≤—Å–µ', '—Å–µ–±—è', '—á—Ç–æ–±—ã', '—ç—Ç–æ—Ç',
    '—Ç–æ–ª—å–∫–æ', '–ø—Ä–∏', '–º–æ–∂–µ—Ç', '–±–µ–∑', '–º–æ–∂–Ω–æ', '–¥–æ', '–∫–æ–≥–¥–∞', '–µ—Å—Ç—å', '–≤–æ—Ç',
    '—É–∂–µ', '–µ—Å–ª–∏', '–¥–∞–∂–µ', '–æ—á–µ–Ω—å', '–≥–æ–¥', '–¥–≤–∞', '—Å–≤–æ–π', '–Ω–∏', '—Ç–µ–ø–µ—Ä—å',
    '–ø–æ–¥', '–≥–¥–µ', '–Ω—É', '–Ω–µ—Ç', '–æ–Ω–∏', '–≤—Ä–µ–º—è', '–∫–æ—Ç–æ—Ä—ã–π', '–º–µ–∂–¥—É', '–º—ã',
    '–ø–æ—Å–ª–µ', '—á–µ—Ä–µ–∑', '—Ç–æ–≥–æ', '–∫—Ç–æ', '–¥–æ–ª–∂–µ–Ω', '—Å–∞–º', '–ø–æ—Ç–æ–º', '–±–æ–ª–µ–µ',
    '—Ä–∞–±–æ—Ç–∞', '–¥–æ–≥–æ–≤–æ—Ä', '–¥–æ–ª–∂–Ω–æ—Å—Ç—å', '–∑–∞—Ä–ø–ª–∞—Ç–∞', '—É—Å–ª–æ–≤–∏—è', '–ø—Ä–∞–≤–æ', '–∑–∞–∫–æ–Ω',
    '–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å', '—Ç—Ä—É–¥–æ–≤–æ–π', '—Ä–∞–±–æ—á–∏–π', '–æ—Ç–ø—É—Å–∫', '—á–∞—Å', '–¥–µ–Ω—å', '–º–µ—Å—è—Ü',
    '–≥–æ–¥', '—Å—Ä–æ–∫', '—Ä–∞–±–æ—Ç–Ω–∏–∫', '—Ä–∞–±–æ—Ç–æ–¥–∞—Ç–µ–ª—å', '–æ–ø–ª–∞—Ç–∞', '–¥–æ–∫—É–º–µ–Ω—Ç', '–ø–∞—Å–ø–æ—Ä—Ç',
    '–ø–∞—Ç–µ–Ω—Ç', '–≤–∏–∑–∞', '—Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è', '–º–∏–≥—Ä–∞—Ü–∏—è', '–∏–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π', '–≥—Ä–∞–∂–¥–∞–Ω–∏–Ω',
    '—Å—Ç—Ä–∞–Ω–∞', '–≥–æ—Ä–æ–¥', '–∞–¥—Ä–µ—Å', '–Ω–æ–º–µ—Ä', '–¥–∞—Ç–∞', '—Ñ–∞–º–∏–ª–∏—è', '–∏–º—è', '–ø–æ–ª',
    '–≤–æ–∑—Ä–∞—Å—Ç', '—Å—É–º–º–∞', '–Ω–∞–ª–æ–≥', '—à—Ç—Ä–∞—Ñ', '–ø—Ä–æ–≤–µ—Ä–∫–∞', '–∏–Ω—Å–ø–µ–∫—Ü–∏—è', '—Å—É–¥',
    '–∂–∞–ª–æ–±–∞', '–∑–∞—è–≤–ª–µ–Ω–∏–µ', '–∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è', '–ø–æ–º–æ—â—å', '—É—Å–ª—É–≥–∞', '–±–µ—Å–ø–ª–∞—Ç–Ω—ã–π',
    '–ø–ª–∞—Ç–Ω—ã–π', '–≥–æ—Ä—è—á–∏–π', '–ª–∏–Ω–∏—è', '—Ç–µ–ª–µ—Ñ–æ–Ω', '–∫–æ–Ω—Ç–∞–∫—Ç', '–∞–¥—Ä–µ—Å', '—Å–∞–π—Ç',
    '–≥—Ä–∞—Ñ–∏–∫', '—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ', '–≤—ã—Ö–æ–¥–Ω–æ–π', '–±—É–¥–Ω–∏–π', '–ø–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫', '–≤—Ç–æ—Ä–Ω–∏–∫',
    '—Å—Ä–µ–¥–∞', '—á–µ—Ç–≤–µ—Ä–≥', '–ø—è—Ç–Ω–∏—Ü–∞', '—Å—É–±–±–æ—Ç–∞', '–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ', '—è–Ω–≤–∞—Ä—å',
    '—Ñ–µ–≤—Ä–∞–ª—å', '–º–∞—Ä—Ç', '–∞–ø—Ä–µ–ª—å', '–º–∞–π', '–∏—é–Ω—å', '–∏—é–ª—å', '–∞–≤–≥—É—Å—Ç', '—Å–µ–Ω—Ç—è–±—Ä—å',
    '–æ–∫—Ç—è–±—Ä—å', '–Ω–æ—è–±—Ä—å', '–¥–µ–∫–∞–±—Ä—å', '–º–∞–∫—Å–∏–º—É–º', '–º–∏–Ω–∏–º—É–º', '–±–æ–ª—å—à–µ', '–º–µ–Ω—å—à–µ',
    '—Ç—Ä–µ–±—É–µ—Ç—Å—è', '–Ω–µ–æ–±—Ö–æ–¥–∏–º–æ', '–Ω—É–∂–Ω–æ', '–º–æ–∂–Ω–æ', '–Ω–µ–ª—å–∑—è', '–∑–∞–ø—Ä–µ—â–µ–Ω–æ',
    '—Ä–∞–∑—Ä–µ—à–µ–Ω–æ', '–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ', '–≤–∞–∂–Ω–æ', '–≤–Ω–∏–º–∞–Ω–∏–µ', '–ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ',
    '–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å', '–∑–∞—â–∏—Ç–∞', '–æ—Ö—Ä–∞–Ω–∞', '–∑–¥–æ—Ä–æ–≤—å–µ', '–∂–∏–∑–Ω—å',
    '–ø—Ä–∞–≤–æ', '–æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å', '–æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å', '–º–∞—Ç–µ—Ä–∏–∞–ª—å–Ω—ã–π', '–¥–µ–Ω–µ–∂–Ω—ã–π'
}

class RussianOnlyCleaner:
    def __init__(self):
        self.ru_data = {}
        self.tg_data = {}
        self.ky_data = {}
        self.uz_data = {}

        self.stats = {
            'total': 0,
            'kept_russian': 0,
            'removed_tajik': 0,
            'removed_kyrgyz': 0,
            'removed_uzbek': 0,
            'removed_unknown': 0
        }

    def load_files(self):
        """–ó–∞–≥—Ä—É–∂–∞–µ—Ç –≤—Å–µ —Ñ–∞–π–ª—ã"""
        print("üìÇ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤...")
        for lang in ['ru', 'tg', 'ky', 'uz']:
            path = LOCALES_DIR / f"{lang}.json"
            if path.exists():
                with open(path, 'r', encoding='utf-8') as f:
                    setattr(self, f'{lang}_data', json.load(f))

    def is_definitely_russian(self, text: str) -> bool:
        """–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç —Ç–æ—á–Ω–æ —Ä—É—Å—Å–∫–∏–º"""
        if not isinstance(text, str) or len(text) < 2:
            return True  # –ö–æ—Ä–æ—Ç–∫–∏–µ —Å—Ç—Ä–æ–∫–∏ –æ—Å—Ç–∞–≤–ª—è–µ–º

        text_lower = text.lower()
        words = re.findall(r'\b\w+\b', text_lower)

        # –ï—Å–ª–∏ –µ—Å—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–∑–≤–µ—Å—Ç–Ω–æ–µ —Ä—É—Å—Å–∫–æ–µ —Å–ª–æ–≤–æ - —ç—Ç–æ —Ä—É—Å—Å–∫–∏–π
        if any(word in RUSSIAN_WORDS for word in words):
            return True

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã
        text_chars = set(text.lower())
        if text_chars & TAJIK_CHARS:
            return False  # –¢–æ—á–Ω–æ —Ç–∞–¥–∂–∏–∫—Å–∫–∏–π
        if text_chars & KYRGYZ_CHARS:
            return False  # –¢–æ—á–Ω–æ –∫–∏—Ä–≥–∏–∑—Å–∫–∏–π

        # –ï—Å–ª–∏ –Ω–µ—Ç —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤, –Ω–æ –∏ –Ω–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–ª—å—à–µ
        return None  # –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ

    def clean_recursive(self, ru_obj: Any, tg_obj: Any, ky_obj: Any, uz_obj: Any, path: str = "") -> Any:
        """–†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –æ—á–∏—â–∞–µ—Ç ru_obj –æ—Ç –Ω–µ—Ä—É—Å—Å–∫–∏—Ö —Ç–µ–∫—Å—Ç–æ–≤"""
        if isinstance(ru_obj, dict):
            result = {}
            for key in ru_obj:
                tg_val = tg_obj.get(key) if isinstance(tg_obj, dict) else None
                ky_val = ky_obj.get(key) if isinstance(ky_obj, dict) else None
                uz_val = uz_obj.get(key) if isinstance(uz_obj, dict) else None

                new_path = f"{path}.{key}" if path else key
                result[key] = self.clean_recursive(ru_obj[key], tg_val, ky_val, uz_val, new_path)

            return result

        elif isinstance(ru_obj, str):
            self.stats['total'] += 1

            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ç–æ—á–Ω–æ –ª–∏ —ç—Ç–æ —Ä—É—Å—Å–∫–∏–π
            is_russian = self.is_definitely_russian(ru_obj)

            if is_russian is True:
                # –¢–æ—á–Ω–æ —Ä—É—Å—Å–∫–∏–π - –æ—Å—Ç–∞–≤–ª—è–µ–º
                self.stats['kept_russian'] += 1
                return ru_obj

            elif is_russian is False:
                # –¢–æ—á–Ω–æ –ù–ï —Ä—É—Å—Å–∫–∏–π (–µ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã)
                if set(ru_obj.lower()) & TAJIK_CHARS:
                    self.stats['removed_tajik'] += 1
                    print(f"  ‚ùå –¢–∞–¥–∂–∏–∫—Å–∫–∏–π: {ru_obj[:60]}")
                elif set(ru_obj.lower()) & KYRGYZ_CHARS:
                    self.stats['removed_kyrgyz'] += 1
                    print(f"  ‚ùå –ö–∏—Ä–≥–∏–∑—Å–∫–∏–π: {ru_obj[:60]}")
                return ""  # –£–¥–∞–ª—è–µ–º

            else:
                # –ù–µ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ - –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é —Å tg/ky/uz
                # –ï—Å–ª–∏ —Å–æ–≤–ø–∞–¥–∞–µ—Ç —Å –Ω–∞—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–º —è–∑—ã–∫–æ–º –ò –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ä—É—Å—Å–∫–∏—Ö —Å–ª–æ–≤ - —É–¥–∞–ª—è–µ–º
                if tg_obj and ru_obj == tg_obj:
                    self.stats['removed_tajik'] += 1
                    print(f"  ‚ùå –¢–∞–¥–∂–∏–∫—Å–∫–∏–π (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {ru_obj[:60]}")
                    return ""
                elif ky_obj and ru_obj == ky_obj:
                    self.stats['removed_kyrgyz'] += 1
                    print(f"  ‚ùå –ö–∏—Ä–≥–∏–∑—Å–∫–∏–π (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {ru_obj[:60]}")
                    return ""
                elif uz_obj and ru_obj == uz_obj:
                    self.stats['removed_uzbek'] += 1
                    print(f"  ‚ùå –£–∑–±–µ–∫—Å–∫–∏–π (—Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ): {ru_obj[:60]}")
                    return ""
                else:
                    # –ù–µ—Ç —Å–æ–≤–ø–∞–¥–µ–Ω–∏–π - –æ—Å—Ç–∞–≤–ª—è–µ–º –∫–∞–∫ —Ä—É—Å—Å–∫–∏–π (–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
                    self.stats['kept_russian'] += 1
                    return ru_obj

        else:
            return ru_obj

    def run(self):
        """–ó–∞–ø—É—Å–∫–∞–µ—Ç –æ—á–∏—Å—Ç–∫—É"""
        print("\n" + "="*60)
        print("üá∑üá∫ –û–ß–ò–°–¢–ö–ê RU.JSON - –¢–û–õ–¨–ö–û –†–£–°–°–ö–ò–ô –Ø–ó–´–ö")
        print("="*60)

        self.load_files()

        # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
        backup_path = LOCALES_DIR / "ru.json.before_russian_only"
        shutil.copy2(LOCALES_DIR / "ru.json", backup_path)
        print(f"üì¶ –ë—ç–∫–∞–ø —Å–æ–∑–¥–∞–Ω: {backup_path.name}\n")

        # –û—á–∏—â–∞–µ–º
        print("üîß –ê–Ω–∞–ª–∏–∑ –∏ –æ—á–∏—Å—Ç–∫–∞ ru.json...\n")
        cleaned_ru = self.clean_recursive(self.ru_data, self.tg_data, self.ky_data, self.uz_data)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º
        print("\nüíæ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...")
        with open(LOCALES_DIR / "ru.json", 'w', encoding='utf-8') as f:
            json.dump(cleaned_ru, f, ensure_ascii=False, indent=2, sort_keys=True)

        # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        print("\n" + "="*60)
        print("‚úÖ –û–ß–ò–°–¢–ö–ê –ó–ê–í–ï–†–®–ï–ù–ê")
        print("="*60)
        print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:")
        print(f"  –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–æ: {self.stats['total']}")
        print(f"  ‚úÖ –û—Å—Ç–∞–≤–ª–µ–Ω–æ (—Ä—É—Å—Å–∫–∏–π): {self.stats['kept_russian']}")
        print(f"  ‚ùå –£–¥–∞–ª–µ–Ω–æ (—Ç–∞–¥–∂–∏–∫—Å–∫–∏–π): {self.stats['removed_tajik']}")
        print(f"  ‚ùå –£–¥–∞–ª–µ–Ω–æ (–∫–∏—Ä–≥–∏–∑—Å–∫–∏–π): {self.stats['removed_kyrgyz']}")
        print(f"  ‚ùå –£–¥–∞–ª–µ–Ω–æ (—É–∑–±–µ–∫—Å–∫–∏–π): {self.stats['removed_uzbek']}")

        removed_total = self.stats['removed_tajik'] + self.stats['removed_kyrgyz'] + self.stats['removed_uzbek']
        print(f"\n  –ò—Ç–æ–≥–æ —É–¥–∞–ª–µ–Ω–æ: {removed_total} ({removed_total/self.stats['total']*100:.1f}%)")
        print(f"  –ò—Ç–æ–≥–æ –æ—Å—Ç–∞–≤–ª–µ–Ω–æ: {self.stats['kept_russian']} ({self.stats['kept_russian']/self.stats['total']*100:.1f}%)")

        print(f"\nüí° –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:")
        print(f"   1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ru.json")
        print(f"   2. –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ: python3 scripts/i18n_validator.py --fix")
        print(f"   3. –ü–µ—Ä–µ–≤–µ–¥–∏—Ç–µ –Ω–∞ –∞–Ω–≥–ª–∏–π—Å–∫–∏–π —á–µ—Ä–µ–∑ Gemini Pro")

def main():
    cleaner = RussianOnlyCleaner()
    cleaner.run()

if __name__ == '__main__':
    main()
