#!/usr/bin/env bash
# workflow_test_program.sh — Тестовый пример workflow с уровнем "program"
# Демонстрирует выполнение задачи ПРОГРАММОЙ вместо LLM
#
# Использование: bash scripts/workflow_test_program.sh
# Все комментарии на русском

set -euo pipefail

echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🧪 ТЕСТ: Выполнение задачи ПРОГРАММОЙ (не LLM)"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""

# Подключаем workflow-helper
source .claude/helpers/workflow-helper.sh

# ═════════════════════════════════════════════════════════════════════
# ПРИМЕР: Показать отчёт о токенах за вчера
# Сложность: program (решается скриптом, не LLM)
# ═════════════════════════════════════════════════════════════════════

TASK_DESC="Показать отчёт о расходе токенов за вчера"

# ШАГ 1 + ШАГ 2: Начало workflow
echo "┌─────────────────────────────────────────────────────────────────┐"
echo "│ ШАГ 1+2: Классификация + начало трекинга                        │"
echo "└─────────────────────────────────────────────────────────────────┘"
workflow_start "$TASK_DESC"
echo ""

# Сохраняем переменные для дальнейшего использования
TASK_ID="$WORKFLOW_TASK_ID"
COMPLEXITY="$WORKFLOW_COMPLEXITY"

echo "Результат классификации:"
echo "  Task ID: $TASK_ID"
echo "  Сложность: $COMPLEXITY"
echo ""

if [[ "$COMPLEXITY" != "program" ]]; then
  echo "⚠️  Ожидалась сложность 'program', но получена '$COMPLEXITY'"
  echo "    Проверь router.js паттерны для задачи: $TASK_DESC"
  exit 1
fi

# ШАГ 3: Выполнение через ПРОГРАММУ
echo "┌─────────────────────────────────────────────────────────────────┐"
echo "│ ШАГ 3: Выполнение через ПРОГРАММУ (не LLM)                      │"
echo "└─────────────────────────────────────────────────────────────────┘"
echo ""

echo "➤ Сложность program → выполнение через скрипт (0 токенов LLM)"
echo ""

# 3.1 Определяем дату вчера
YESTERDAY=$(date -v-1d +%Y-%m-%d 2>/dev/null || date -d "yesterday" +%Y-%m-%d 2>/dev/null || echo "2026-02-11")
echo "  1. Дата для отчёта: $YESTERDAY"
echo ""

# 3.2 Выполняем программу
echo "  2. Выполнение: python3 -m src.reporting.token_tracker --date $YESTERDAY"
echo ""

PROGRAM_CMD="python3 -m src.reporting.token_tracker --date $YESTERDAY"
workflow_execute_program "$PROGRAM_CMD"

echo "  3. Программа выполнена (0 токенов LLM на генерацию кода!)"
echo ""

# 3.3 Opus только валидирует результат
echo "  4. Opus валидация результата программы..."
workflow_record opus validator 300 100
echo "     ✅ Записано: opus/validator - 300 in, 100 out"
echo ""

# ШАГ 4: Завершение и отчёт
echo "┌─────────────────────────────────────────────────────────────────┐"
echo "│ ШАГ 4: Завершение и отчёт о расходе токенов                     │"
echo "└─────────────────────────────────────────────────────────────────┘"
echo ""
workflow_finish

# Проверка compliance
echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "🔍 ПРОВЕРКА СОБЛЮДЕНИЯ ПРАВИЛ"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
bash .claude/helpers/task-enforcer.sh check "$TASK_ID"

echo ""
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo "✅ ТЕСТ ЗАВЕРШЁН УСПЕШНО"
echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━"
echo ""
echo "Демонстрация уровня 'program':"
echo "  ✅ router.js определил: program"
echo "  ✅ Программа выполнилась через Bash (0 токенов LLM на генерацию)"
echo "  ✅ Opus только проверил результат (~400 токенов)"
echo "  ✅ Экономия: ~99% по сравнению с генерацией кода LLM"
echo ""
echo "Это МАКСИМАЛЬНАЯ экономия — задача решена программой, не LLM!"
echo ""
