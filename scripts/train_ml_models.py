#!/usr/bin/env python3
"""
–°–∫—Ä–∏–ø—Ç –æ–±—É—á–µ–Ω–∏—è ML –º–æ–¥–µ–ª–µ–π –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞.

–ó–∞–≥—Ä—É–∂–∞–µ—Ç –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ token_usage.db, –æ–±—É—á–∞–µ—Ç –º–æ–¥–µ–ª–∏
TaskClassifier –∏ AgentSelector, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±—É—á–µ–Ω–Ω—ã–µ –º–æ–¥–µ–ª–∏.
"""

import sys
import os
import sqlite3
from datetime import datetime
from typing import List, Tuple

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –≤ PYTHONPATH
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '..'))

from src.ml.task_classifier import TaskClassifier
from src.ml.agent_selector import AgentSelector


def normalize_complexity(raw: str) -> str:
    """
    –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–∫–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ –∏–∑ –ë–î.

    –í –ë–î –≤—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã: SIMPLE/simple, COMPLEX/complex, MEDIUM/medium,
    "—Å—Ä–µ–¥–Ω—è—è", "program" –∏ —Ç.–¥.

    Returns:
        –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è –º–µ—Ç–∫–∞: program, simple, medium, complex
    """
    mapping = {
        'simple': 'simple',
        'medium': 'medium',
        'complex': 'complex',
        'program': 'program',
        'trivial': 'simple',
        'very_complex': 'complex',
        # –†—É—Å—Å–∫–∏–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã
        '–ø—Ä–æ—Å—Ç–∞—è': 'simple',
        '—Å—Ä–µ–¥–Ω—è—è': 'medium',
        '—Å–ª–æ–∂–Ω–∞—è': 'complex',
        '–ø—Ä–æ–≥—Ä–∞–º–º–∞': 'program',
    }
    lower = raw.strip().lower()
    return mapping.get(lower, 'simple')


def load_training_data_from_db(db_path: str = 'data/token_usage.db') -> Tuple[List[str], List[str]]:
    """
    –ó–∞–≥—Ä—É–∑–∫–∞ –æ–±—É—á–∞—é—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ –±–∞–∑—ã —Ç–æ–∫–µ–Ω–æ–≤.

    Args:
        db_path: –ü—É—Ç—å –∫ –ë–î

    Returns:
        (—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
    """
    if not os.path.exists(db_path):
        print(f"‚ùå –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: {db_path}")
        return [], []

    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()

    # –ü–æ–ª–µ –≤ —Å—Ö–µ–º–µ –ë–î: query (–Ω–µ description)
    cursor.execute("""
        SELECT query, complexity
        FROM tasks
        WHERE complexity IS NOT NULL
        AND complexity != ''
        AND query IS NOT NULL
        AND query != ''
        ORDER BY started_at DESC
    """)

    rows = cursor.fetchall()
    conn.close()

    # –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –º–µ—Ç–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    tasks = []
    labels = []
    for query, complexity in rows:
        normalized = normalize_complexity(complexity)
        tasks.append(query)
        labels.append(normalized)

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    from collections import Counter
    label_counts = Counter(labels)
    print(f"üìä –ó–∞–≥—Ä—É–∂–µ–Ω–æ {len(tasks)} –ø—Ä–∏–º–µ—Ä–æ–≤ –∑–∞–¥–∞—á –∏–∑ –ë–î")
    print(f"   –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ: {dict(label_counts)}")
    return tasks, labels


def generate_synthetic_data() -> Tuple[List[str], List[str]]:
    """
    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ –æ–±—É—á–µ–Ω–∏—è.

    –ú–∏–Ω–∏–º—É–º 30 –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–∞ –∫–ª–∞—Å—Å –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ–π accuracy > 90%.

    Returns:
        (—Å–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á, —Å–ø–∏—Å–æ–∫ –º–µ—Ç–æ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
    """
    # === Program (—Ä–µ—à–∞–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º/—É—Ç–∏–ª–∏—Ç–æ–π, –±–µ–∑ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–æ–¥–∞) ===
    program_tasks = [
        # –û—Ç—á—ë—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        "–ü–æ–∫–∞–∂–∏ –æ—Ç—á—ë—Ç –æ —Ä–∞—Å—Ö–æ–¥–µ —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ –≤—á–µ—Ä–∞",
        "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ç–æ–∫–µ–Ω–æ–≤ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –º–µ—Å—è—Ü",
        "–í—ã–≤–µ–¥–∏ –æ—Ç—á—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –º–æ–¥–µ–ª–µ–π",
        "–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–∞–º—è—Ç–∏",
        "–°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∑–∞–¥–∞—á –∑–∞ –ø–æ—Å–ª–µ–¥–Ω—é—é –Ω–µ–¥–µ–ª—é",
        "–°–∫–æ–ª—å–∫–æ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ—Ç—Ä–∞—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è",
        "–û—Ç—á—ë—Ç –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏ –∑–∞ —ç—Ç—É –Ω–µ–¥–µ–ª—é",
        "–ü–æ–∫–∞–∂–∏ —Ä–∞—Å—Ö–æ–¥ —Ç–æ–∫–µ–Ω–æ–≤ –ø–æ –º–æ–¥–µ–ª—è–º",
        "–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–¥–∞—á –ø–æ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏",
        "–û—Ç—á—ë—Ç –æ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤",
        # –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –ø—Ä–æ–≤–µ—Ä–∫–∞
        "–í–∞–ª–∏–¥–∞—Ü–∏—è JSON –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏",
        "–ü—Ä–æ–≤–µ—Ä—å JSON —Ñ–∞–π–ª –Ω–∞ –æ—à–∏–±–∫–∏",
        "–í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å —Å—Ö–µ–º—É config.yaml",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å YAML —Ñ–∞–π–ª–æ–≤",
        "–ü—Ä–æ–≤–∞–ª–∏–¥–∏—Ä—É–π —Ñ–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö –≤ data.json",
        # –õ–∏–Ω—Ç–∏–Ω–≥ –∏ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        "–ó–∞–ø—É—Å—Ç–∏—Ç—å –ª–∏–Ω—Ç–µ—Ä –Ω–∞ –≤—Å—ë–º –ø—Ä–æ–µ–∫—Ç–µ",
        "–û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–æ–¥ —á–µ—Ä–µ–∑ black",
        "–ó–∞–ø—É—Å—Ç–∏ flake8 –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∏–ª—è",
        "–§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Python —Ñ–∞–π–ª–æ–≤ —á–µ—Ä–µ–∑ autopep8",
        "–ü—Ä–æ–≥–æ–Ω–∏ pylint –Ω–∞ –º–æ–¥—É–ª–µ src",
        "–ó–∞–ø—É—Å—Ç–∏ eslint –Ω–∞ JavaScript —Ñ–∞–π–ª–∞—Ö",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ prettier",
        # –¢–µ—Å—Ç—ã
        "–ó–∞–ø—É—Å—Ç–∏—Ç—å —é–Ω–∏—Ç-—Ç–µ—Å—Ç—ã",
        "–ó–∞–ø—É—Å—Ç–∏ pytest –¥–ª—è –º–æ–¥—É–ª—è ml",
        "–ü—Ä–æ–≥–æ–Ω–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–µ–∫—Ç–∞",
        "–ó–∞–ø—É—Å—Ç–∏ —Ç–µ—Å—Ç—ã —Å coverage –æ—Ç—á—ë—Ç–æ–º",
        "–ó–∞–ø—É—Å—Ç–∏—Ç—å npm test",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ç–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç",
        # –°–∏—Å—Ç–µ–º–Ω—ã–µ —É—Ç–∏–ª–∏—Ç—ã
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∏–Ω—Ç–∞–∫—Å–∏—Å Python —Ñ–∞–π–ª–æ–≤",
        "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –≤ PT_Standart",
        "–ü–æ–∫–∞–∑–∞—Ç—å git log –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 –∫–æ–º–º–∏—Ç–æ–≤",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è",
        "–ü–æ–∫–∞–∑–∞—Ç—å —Å–ø–∏—Å–æ–∫ –∏–∑–º–µ–Ω—ë–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤",
        "–í—ã–≤–µ—Å—Ç–∏ —Ä–∞–∑–º–µ—Ä –ø—Ä–æ–µ–∫—Ç–∞ –ø–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è–º",
        "–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞–ª–∏—á–∏–µ —Å–µ–∫—Ä–µ—Ç–æ–≤ –≤ –∫–æ–¥–µ",
        "–ó–∞–ø—É—Å—Ç–∏—Ç—å –±–µ–Ω—á–º–∞—Ä–∫ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏",
        "–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ä–µ–≤–æ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –ø—Ä–æ–µ–∫—Ç–∞",
        # –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ program-–ø—Ä–∏–º–µ—Ä—ã (–¥–ª—è –±–∞–ª–∞–Ω—Å–∞ ‚Äî class underrepresented –≤ –ë–î)
        "–ü–æ—Å—á–∏—Ç–∞–π —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞ –≤ –ø—Ä–æ–µ–∫—Ç–µ",
        "–í—ã–≤–µ–¥–∏ –≤—Å–µ TODO –∏ FIXME –≤ –∫–æ–¥–µ",
        "–ê–Ω–∞–ª–∏–∑ –∏–º–ø–æ—Ä—Ç–æ–≤ –∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π",
        "–ü—Ä–æ–≤–µ—Ä—å –Ω–∞–ª–∏—á–∏–µ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤ —Ñ–∞–π–ª–æ–≤",
        "–ü–æ–∫–∞–∂–∏ —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å –≤–µ—Ä—Å–∏—è–º–∏",
        "–ü—Ä–æ–≤–µ—Ä—å —á—Ç–æ pre-commit hooks –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã",
        "–ó–∞–ø—É—Å—Ç–∏ mypy –Ω–∞ –ø—Ä–æ–µ–∫—Ç–µ",
        "–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–∑–º–µ—Ä –≤—Å–µ—Ö –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π –≤ –±–∞–π—Ç–∞—Ö",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å Dockerfile",
        "–ü–æ–∫–∞–∂–∏ git diff –º–µ–∂–¥—É —Ç–µ–∫—É—â–µ–π –∏ –ø—Ä–æ—à–ª–æ–π –≤–µ—Ç–∫–æ–π",
        "–ó–∞–ø—É—Å—Ç–∏ security scan –Ω–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è—Ö",
        "–í—ã–≤–µ—Å—Ç–∏ –æ—Ç—á—ë—Ç –æ —Ç–µ—Å—Ç–æ–≤–æ–º –ø–æ–∫—Ä—ã—Ç–∏–∏",
        "–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å –≤–µ—Ä—Å–∏–π Python –ø–∞–∫–µ—Ç–æ–≤",
        "–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –æ—à–∏–±–∫–∏ –∏–∑ CI/CD",
        "–ü–æ–∫–∞–∂–∏ —Å–≤–æ–¥–∫—É –ø–æ –æ—Ç–∫—Ä—ã—Ç—ã–º PR",
    ]

    # === Simple (1-2 —Ñ–∞–π–ª–∞, <50 —Å—Ç—Ä–æ–∫, –ø—Ä–æ—Å—Ç—ã–µ –ø—Ä–∞–≤–∫–∏) ===
    simple_tasks = [
        # –ü—Ä–∞–≤–∫–∏ –∑–Ω–∞—á–µ–Ω–∏–π
        "–î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É email –≤ validators.py",
        "–ò—Å–ø—Ä–∞–≤—å —Å–∏–Ω—Ç–∞–∫—Å–∏—á–µ—Å–∫—É—é –æ—à–∏–±–∫—É –≤ test.py",
        "–ò–∑–º–µ–Ω–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã MAX_RETRIES –Ω–∞ 5",
        "–ü–æ–º–µ–Ω—è–π –ø–æ—Ä—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å 8080 –Ω–∞ 3000",
        "–û–±–Ω–æ–≤–∏ –≤–µ—Ä—Å–∏—é –ø–∞–∫–µ—Ç–∞ –≤ package.json",
        "–ò–∑–º–µ–Ω–∏ —Ç–∞–π–º–∞—É—Ç –∑–∞–ø—Ä–æ—Å–∞ –Ω–∞ 30 —Å–µ–∫—É–Ω–¥",
        "–ü–æ–º–µ–Ω—è–π —Ü–≤–µ—Ç –∫–Ω–æ–ø–∫–∏ –Ω–∞ —Å–∏–Ω–∏–π",
        "–£—Å—Ç–∞–Ω–æ–≤–∏ –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø–∞—Ä–∞–º–µ—Ç—Ä–∞",
        # –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
        "–ü–µ—Ä–µ–∏–º–µ–Ω—É–π —Ñ—É–Ω–∫—Ü–∏—é getUserData –≤ get_user_data",
        "–ü–µ—Ä–µ–∏–º–µ–Ω—É–π –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é tmp –≤ result",
        "–ü–µ—Ä–µ–∏–º–µ–Ω—É–π –∫–ª–∞—Å—Å Utils –≤ Helpers",
        "–ü–µ—Ä–µ–∏–º–µ–Ω—É–π —Ñ–∞–π–ª config.py –≤ settings.py",
        # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç–æ–≥–æ –∫–æ–¥–∞
        "–î–æ–±–∞–≤—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ —Ñ—É–Ω–∫—Ü–∏–∏ calculate_total",
        "–î–æ–±–∞–≤—å docstring –∫ –∫–ª–∞—Å—Å—É User",
        "–î–æ–±–∞–≤—å type hint –∫ —Ñ—É–Ω–∫—Ü–∏–∏ process_data",
        "–î–æ–±–∞–≤—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤ —Ñ—É–Ω–∫—Ü–∏—é save_user",
        "–î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –Ω–∞ None –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º –º–µ—Ç–æ–¥–∞",
        "–î–æ–±–∞–≤—å return type –∫ —Ñ—É–Ω–∫—Ü–∏–∏ get_name",
        # –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫
        "–ò—Å–ø—Ä–∞–≤—å –æ–ø–µ—á–∞—Ç–∫—É –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –æ–± –æ—à–∏–±–∫–µ",
        "–ò—Å–ø—Ä–∞–≤—å –±–∞–≥ —Å NoneType –≤ get_user",
        "–ò—Å–ø—Ä–∞–≤—å –æ—à–∏–±–∫—É –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å",
        "–ò—Å–ø—Ä–∞–≤—å –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É",
        "–ü–æ—á–∏–Ω–∏ —Å–ª–æ–º–∞–Ω–Ω—ã–π –∏–º–ø–æ—Ä—Ç –≤ utils.py",
        "–ò—Å–ø—Ä–∞–≤—å off-by-one –æ—à–∏–±–∫—É –≤ —Ü–∏–∫–ª–µ",
        # –£–¥–∞–ª–µ–Ω–∏–µ
        "–£–¥–∞–ª–∏ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –∏–º–ø–æ—Ä—Ç –≤ main.py",
        "–£–±–µ—Ä–∏ deprecated warning –∏–∑ –∫–æ–¥–∞",
        "–£–¥–∞–ª–∏ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –≤ handler.py",
        "–£–±–µ—Ä–∏ console.log –∏–∑ production –∫–æ–¥–∞",
        # –ü—Ä–æ—Å—Ç—ã–µ —Ñ–∏–∫—Å—ã
        "–ò—Å–ø—Ä–∞–≤—å –æ—Ç—Å—Ç—É–ø—ã –≤ —Ñ–∞–π–ª–µ config.py",
        "–î–æ–±–∞–≤—å –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞",
        "–ó–∞–º–µ–Ω–∏ print –Ω–∞ logger.info",
        "–û–±–Ω–æ–≤–∏ URL –≤ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–µ API_BASE",
        "–î–æ–±–∞–≤—å –æ–±—Ä–∞–±–æ—Ç–∫—É –∏—Å–∫–ª—é—á–µ–Ω–∏—è FileNotFoundError",
        "–ò—Å–ø—Ä–∞–≤—å –∫–æ–¥–∏—Ä–æ–≤–∫—É —Ñ–∞–π–ª–∞ –Ω–∞ UTF-8",
        "–î–æ–±–∞–≤—å –ø—Ä–æ–≤–µ—Ä–∫—É –¥–ª–∏–Ω—ã –ø–∞—Ä–æ–ª—è –º–∏–Ω–∏–º—É–º 8 —Å–∏–º–≤–æ–ª–æ–≤",
        "–ó–∞–º–µ–Ω–∏ —É—Å—Ç–∞—Ä–µ–≤—à–∏–π –º–µ—Ç–æ–¥ –Ω–∞ –Ω–æ–≤—ã–π",
    ]

    # === Medium (3-5 —Ñ–∞–π–ª–æ–≤, –Ω–æ–≤–∞—è —Ñ–∏—á–∞, API, –º–æ–¥—É–ª—å) ===
    medium_tasks = [
        # API endpoints
        "–î–æ–±–∞–≤—å API endpoint –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "–°–æ–∑–¥–∞–π REST endpoint –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤",
        "–†–µ–∞–ª–∏–∑—É–π endpoint –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤",
        "–î–æ–±–∞–≤—å API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è",
        "–°–æ–∑–¥–∞–π endpoint –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ –∫–∞—Ç–∞–ª–æ–≥—É",
        "–†–µ–∞–ª–∏–∑—É–π endpoint –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ CSV",
        # –ú–æ–¥—É–ª–∏ –∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
        "–°–æ–∑–¥–∞–π –º–æ–¥—É–ª—å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å JWT —Ç–æ–∫–µ–Ω–∞–º–∏",
        "–†–µ–∞–ª–∏–∑—É–π –º–æ–¥—É–ª—å –æ—Ç–ø—Ä–∞–≤–∫–∏ email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π",
        "–°–æ–∑–¥–∞–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Ñ–æ—Ä–º—ã —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
        "–î–æ–±–∞–≤—å –º–æ–¥—É–ª—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è —Å —Ä–æ—Ç–∞—Ü–∏–µ–π —Ñ–∞–π–ª–æ–≤",
        "–†–µ–∞–ª–∏–∑—É–π –º–æ–¥—É–ª—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å TTL",
        "–°–æ–∑–¥–∞–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤–Ω–µ—à–Ω–∏–º API",
        # –§–∏—á–∏
        "–†–µ–∞–ª–∏–∑—É–π pagination –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤",
        "–î–æ–±–∞–≤—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ Redis",
        "–†–µ–∞–ª–∏–∑—É–π rate limiting –¥–ª—è API endpoints",
        "–î–æ–±–∞–≤—å –≤–∞–ª–∏–¥–∞—Ü–∏—é –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Pydantic",
        "–†–µ–∞–ª–∏–∑—É–π —Å–∏—Å—Ç–µ–º—É —Ç–µ–≥–æ–≤ –¥–ª—è —Å—Ç–∞—Ç–µ–π",
        "–î–æ–±–∞–≤—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –≤ —Å–ø–∏—Å–æ–∫",
        # –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
        "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–∏–º API –æ–ø–ª–∞—Ç—ã Stripe",
        "–°–æ–∑–¥–∞–π middleware –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤",
        "–ü–æ–¥–∫–ª—é—á–∏ –æ—Ç–ø—Ä–∞–≤–∫—É SMS —á–µ—Ä–µ–∑ Twilio",
        "–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OAuth2 –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–º Google",
        "–ü–æ–¥–∫–ª—é—á–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —á–µ—Ä–µ–∑ Prometheus",
        "–î–æ–±–∞–≤—å webhook –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –≤ Slack",
        # –ë–î –∏ –¥–∞–Ω–Ω—ã–µ
        "–°–æ–∑–¥–∞–π –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –∑–∞–∫–∞–∑–æ–≤",
        "–î–æ–±–∞–≤—å –º–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤",
        "–†–µ–∞–ª–∏–∑—É–π CRUD –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏",
        "–î–æ–±–∞–≤—å –ø–æ–ª–Ω–æ—Ç–µ–∫—Å—Ç–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ —Å—Ç–∞—Ç—å—è–º",
        "–°–æ–∑–¥–∞–π —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
        "–î–æ–±–∞–≤—å –∏–Ω–¥–µ–∫—Å—ã –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤",
        # –¢–µ—Å—Ç—ã –¥–ª—è —Ñ–∏—á–µ–π
        "–ù–∞–ø–∏—à–∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è API –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏",
        "–°–æ–∑–¥–∞–π —Ç–µ—Å—Ç—ã –¥–ª—è –º–æ–¥—É–ª—è –æ–ø–ª–∞—Ç—ã",
        "–î–æ–±–∞–≤—å E2E —Ç–µ—Å—Ç—ã –¥–ª—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏",
        "–ù–∞–ø–∏—à–∏ —Ç–µ—Å—Ç—ã –¥–ª—è –Ω–æ–≤–æ–≥–æ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ Dashboard",
        "–†–µ–∞–ª–∏–∑—É–π –º–æ–∫-—Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è API",
        "–î–æ–±–∞–≤—å –Ω–∞–≥—Ä—É–∑–æ—á–Ω—ã–µ —Ç–µ—Å—Ç—ã –¥–ª—è endpoint /api/search",
    ]

    # === Complex (6+ —Ñ–∞–π–ª–æ–≤, –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞, –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å) ===
    complex_tasks = [
        # –†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥
        "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏ –≤—Å—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É auth –º–æ–¥—É–ª—è —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º JWT",
        "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ —Å–∏—Å—Ç–µ–º—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—à–∏–±–æ–∫ –ø–æ –≤—Å–µ–º—É –ø—Ä–æ–µ–∫—Ç—É",
        "–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π —Å–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º –Ω–∞ Repository pattern",
        "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏ –º–æ–Ω–æ–ª–∏—Ç –≤ –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É",
        "–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π —Å–∏—Å—Ç–µ–º—É —Ä–æ–ª–µ–π –∏ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞",
        "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏ —Å–∏—Å—Ç–µ–º—É –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –Ω–∞ 12-factor app",
        # –ú–∏–≥—Ä–∞—Ü–∏–∏
        "–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Å PostgreSQL –Ω–∞ MongoDB",
        "–ú–∏–≥—Ä–∞—Ü–∏—è —Å REST –Ω–∞ GraphQL API",
        "–ü–µ—Ä–µ–Ω–æ—Å –ø—Ä–æ–µ–∫—Ç–∞ —Å JavaScript –Ω–∞ TypeScript",
        "–ú–∏–≥—Ä–∞—Ü–∏—è CI/CD —Å Jenkins –Ω–∞ GitHub Actions",
        "–ü–µ—Ä–µ–Ω–æ—Å —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–æ–≤ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –Ω–∞ S3",
        "–ú–∏–≥—Ä–∞—Ü–∏—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –Ω–∞ SSO",
        # –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å
        "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤—Å–µ SQL –∑–∞–ø—Ä–æ—Å—ã",
        "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî —É–º–µ–Ω—å—à–∏ –±–∞–Ω–¥–ª –Ω–∞ 50%",
        "–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å —Å–∏—Å—Ç–µ–º—É –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è",
        "–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ü–µ–ª–∏–∫–æ–º",
        "–í–Ω–µ–¥—Ä–∏ lazy loading –¥–ª—è –≤—Å–µ—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è",
        "–û–ø—Ç–∏–º–∏–∑–∏—Ä—É–π –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ —Å–ø–∏—Å–∫–æ–≤",
        # –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
        "Security –∞—É–¥–∏—Ç –∏ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≤—Å–µ—Ö —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π",
        "–í–Ω–µ–¥—Ä–∏ CSP –∏ –∑–∞—â–∏—Ç—É –æ—Ç XSS –ø–æ –≤—Å–µ–º—É –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—é",
        "–†–µ–∞–ª–∏–∑—É–π –ø–æ–ª–Ω—É—é —Å–∏—Å—Ç–µ–º—É –∞—É–¥–∏—Ç–∞ –¥–µ–π—Å—Ç–≤–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "–ü—Ä–æ–≤–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –≤—Å–µ—Ö endpoints –∏ –¥–æ–±–∞–≤—å –∑–∞—â–∏—Ç—É",
        "–í–Ω–µ–¥—Ä–∏ —à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö at rest –∏ in transit",
        "–†–µ–∞–ª–∏–∑—É–π –¥–≤—É—Ö—Ñ–∞–∫—Ç–æ—Ä–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é",
        # –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞
        "–í–Ω–µ–¥—Ä–µ–Ω–∏–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –¥–ª—è payments",
        "–ü–µ—Ä–µ–ø–∏—Å–∞—Ç—å –≤–µ—Å—å frontend –Ω–∞ TypeScript + React",
        "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è distributed caching —Å Redis Cluster",
        "–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ event-driven —Å–∏—Å—Ç–µ–º—ã —Å RabbitMQ",
        "–í–Ω–µ–¥—Ä–∏ CQRS –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è –º–æ–¥—É–ª—è –∑–∞–∫–∞–∑–æ–≤",
        "–°–ø—Ä–æ–µ–∫—Ç–∏—Ä—É–π –∏ —Ä–µ–∞–ª–∏–∑—É–π —Å–∏—Å—Ç–µ–º—É –ø–ª–∞–≥–∏–Ω–æ–≤",
        # –ú–∞—Å—à—Ç–∞–±–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        "–î–æ–±–∞–≤—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –º—É–ª—å—Ç–∏—Ç–µ–Ω–∞–Ω—Ç–Ω–æ—Å—Ç–∏ –≤–æ –≤—Å—ë –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ",
        "–†–µ–∞–ª–∏–∑—É–π —Å–∏—Å—Ç–µ–º—É –≤–µ—Ä—Å–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è API (v1, v2)",
        "–í–Ω–µ–¥—Ä–∏ –ø–æ–ª–Ω–æ–µ –ø–æ–∫—Ä—ã—Ç–∏–µ —Ç–µ—Å—Ç–∞–º–∏ > 80% –¥–ª—è –≤—Å–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞",
        "–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π –≤—Å—é —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å –æ—á–µ—Ä–µ–¥—è–º–∏",
        "–†–µ–∞–ª–∏–∑—É–π –ø–æ–ª–Ω—ã–π pipeline CI/CD —Å –∞–≤—Ç–æ–¥–µ–ø–ª–æ–µ–º",
        "–ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–π —Å–∏—Å—Ç–µ–º—É —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤",
    ]

    tasks = program_tasks + simple_tasks + medium_tasks + complex_tasks

    labels = (
        ['program'] * len(program_tasks) +
        ['simple'] * len(simple_tasks) +
        ['medium'] * len(medium_tasks) +
        ['complex'] * len(complex_tasks)
    )

    print(f"üß™ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(tasks)} —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤")
    print(f"   program: {len(program_tasks)}, simple: {len(simple_tasks)}, "
          f"medium: {len(medium_tasks)}, complex: {len(complex_tasks)}")
    return tasks, labels


def train_task_classifier(use_synthetic: bool = False):
    """
    –û–±—É—á–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –∑–∞–¥–∞—á.

    Args:
        use_synthetic: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –ë–î –ø—É—Å—Ç–∞
    """
    print("\n" + "="*70)
    print("üéØ –û–ë–£–ß–ï–ù–ò–ï –ö–õ–ê–°–°–ò–§–ò–ö–ê–¢–û–†–ê –ó–ê–î–ê–ß (TaskClassifier)")
    print("="*70)

    # –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    tasks, labels = load_training_data_from_db()

    # –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ
    if len(tasks) < 10 or use_synthetic:
        print("‚ö†Ô∏è  –î–æ–±–∞–≤–ª—è–µ–º —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∞—Å—Å–æ–≤")
        synth_tasks, synth_labels = generate_synthetic_data()
        tasks.extend(synth_tasks)
        labels.extend(synth_labels)

    if len(tasks) < 10:
        print("‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ–±—É—á–µ–Ω–∏—è (–º–∏–Ω–∏–º—É–º 10 –ø—Ä–∏–º–µ—Ä–æ–≤)")
        print("üí° –°–æ–≤–µ—Ç: –ó–∞–ø—É—Å—Ç–∏—Ç–µ —Å–∫—Ä–∏–ø—Ç —Å --synthetic –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö")
        return None

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞ –∫–ª–∞—Å—Å–æ–≤ –¥–ª—è stratify
    from collections import Counter
    label_counts = Counter(labels)
    print(f"\nüìä –ò—Ç–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö (–¥–æ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏): {len(tasks)} –ø—Ä–∏–º–µ—Ä–æ–≤")
    for label, count in sorted(label_counts.items()):
        print(f"   - {label}: {count}")

    # Oversampling –º–∞–ª—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –¥–æ —Ä–∞–∑–º–µ—Ä–∞ –Ω–∞–∏–±–æ–ª—å—à–µ–≥–æ
    max_count = max(label_counts.values())
    import random
    random.seed(42)
    balanced_tasks = list(tasks)
    balanced_labels = list(labels)

    for label in label_counts:
        count = label_counts[label]
        if count < max_count:
            # –ò–Ω–¥–µ–∫—Å—ã –ø—Ä–∏–º–µ—Ä–æ–≤ –¥–∞–Ω–Ω–æ–≥–æ –∫–ª–∞—Å—Å–∞
            indices = [i for i, l in enumerate(labels) if l == label]
            # –î—É–±–ª–∏—Ä—É–µ–º –¥–æ max_count
            needed = max_count - count
            extra_indices = [random.choice(indices) for _ in range(needed)]
            for idx in extra_indices:
                balanced_tasks.append(tasks[idx])
                balanced_labels.append(labels[idx])

    tasks = balanced_tasks
    labels = balanced_labels

    label_counts = Counter(labels)
    print(f"\nüìä –ò—Ç–æ–≥–æ –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∏): {len(tasks)} –ø—Ä–∏–º–µ—Ä–æ–≤")
    for label, count in sorted(label_counts.items()):
        print(f"   - {label}: {count}")

    # –û–±—É—á–µ–Ω–∏–µ
    classifier = TaskClassifier()

    metrics = classifier.train(tasks, labels, test_size=0.2)

    print(f"\n‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞!")
    print(f"   - –¢–æ—á–Ω–æ—Å—Ç—å (accuracy): {metrics['accuracy']:.2%}")
    print(f"   - –û–±—É—á–∞—é—â–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {metrics['train_samples']}")
    print(f"   - –¢–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {metrics['test_samples']}")
    print(f"\nüìä –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –æ—Ç—á—ë—Ç:")
    print(metrics['report'])

    # –í–∞–∂–Ω—ã–µ –ø—Ä–∏–∑–Ω–∞–∫–∏
    print("\nüîç –¢–æ–ø-10 –≤–∞–∂–Ω—ã—Ö –ø—Ä–∏–∑–Ω–∞–∫–æ–≤:")
    top_features = classifier.get_feature_importance(top_n=10)
    for i, (feature, importance) in enumerate(top_features, 1):
        print(f"   {i}. {feature}: {importance:.4f}")

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏
    model_path = 'data/models/task_classifier.pkl'
    classifier.save(model_path)
    print(f"\nüíæ –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {model_path}")

    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö
    print("\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä–∞—Ö:")
    test_cases = [
        "–î–æ–±–∞–≤—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email",
        "–†–µ—Ñ–∞–∫—Ç–æ—Ä–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",
        "–ü–æ–∫–∞–∂–∏ –æ—Ç—á—ë—Ç –æ —Ç–æ–∫–µ–Ω–∞—Ö",
        "–°–æ–∑–¥–∞–π API endpoint –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π",
        "–ò—Å–ø—Ä–∞–≤—å –æ–ø–µ—á–∞—Ç–∫—É –≤ README",
    ]
    for task in test_cases:
        prediction, confidence = classifier.predict(task, return_confidence=True)
        print(f"   '{task}' ‚Üí {prediction} (—É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: {confidence:.2%})")

    return classifier


def train_agent_selector():
    """–û–±—É—á–µ–Ω–∏–µ —Å–µ–ª–µ–∫—Ç–æ—Ä–∞ –∞–≥–µ–Ω—Ç–æ–≤."""
    print("\n" + "="*70)
    print("ü§ñ –û–ë–£–ß–ï–ù–ò–ï –°–ï–õ–ï–ö–¢–û–†–ê –ê–ì–ï–ù–¢–û–í (AgentSelector)")
    print("="*70)

    # –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç–∏ –±—É–¥–µ—Ç –∏–∑ –ë–î)
    # –§–æ—Ä–º–∞—Ç: [task_similarity, agent_performance, agent_load, task_complexity, spec_bonus]
    features = []
    scores = []

    # 50 –ø—Ä–∏–º–µ—Ä–æ–≤ —É—Å–ø–µ—à–Ω—ã—Ö –ø–∞—Ä (–∑–∞–¥–∞—á–∞, –∞–≥–µ–Ω—Ç)
    for i in range(50):
        # –£—Å–ø–µ—à–Ω—ã–µ –ø–∞—Ä—ã: –≤—ã—Å–æ–∫–∞—è performance, –Ω–∏–∑–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
        features.append([0.8, 0.9, 0.8, 2.0, 1.0])  # –•–æ—Ä–æ—à–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        scores.append(0.95)

        features.append([0.6, 0.85, 0.7, 1.0, 0.0])  # –°—Ä–µ–¥–Ω–µ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        scores.append(0.75)

        # –ù–µ—É–¥–∞—á–Ω—ã–µ –ø–∞—Ä—ã: –Ω–∏–∑–∫–∞—è performance –∏–ª–∏ –≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
        features.append([0.3, 0.5, 0.3, 3.0, 0.0])  # –ü–ª–æ—Ö–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
        scores.append(0.3)

    print(f"üìä –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ {len(features)} –ø—Ä–∏–º–µ—Ä–æ–≤ –ø–∞—Ä (–∑–∞–¥–∞—á–∞, –∞–≥–µ–Ω—Ç)")

    # –û–±—É—á–µ–Ω–∏–µ
    selector = AgentSelector()
    metrics = selector.train(features, scores, test_size=0.2)

    print(f"\n‚úÖ –ú–æ–¥–µ–ª—å –æ–±—É—á–µ–Ω–∞!")
    print(f"   - MSE: {metrics['mse']:.4f}")
    print(f"   - R¬≤: {metrics['r2']:.4f}")
    print(f"   - –û–±—É—á–∞—é—â–∏—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {metrics['train_samples']}")
    print(f"   - –¢–µ—Å—Ç–æ–≤—ã—Ö –ø—Ä–∏–º–µ—Ä–æ–≤: {metrics['test_samples']}")

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
    model_path = 'data/models/agent_selector.pkl'
    selector.save(model_path)
    print(f"\nüíæ –ú–æ–¥–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {model_path}")

    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
    print("\nüß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏—è –∞–≥–µ–Ω—Ç–æ–≤:")
    task_features = {
        'complexity_num': 2.0,
        'requires_security': 1,
        'requires_performance': 0,
        'domain': 'backend'
    }

    available_agents = [
        {'type': 'coder', 'past_performance': 0.85, 'current_load': 0.3, 'specialization': ['backend', 'api']},
        {'type': 'security-architect', 'past_performance': 0.9, 'current_load': 0.5, 'specialization': ['security']},
        {'type': 'tester', 'past_performance': 0.75, 'current_load': 0.1, 'specialization': ['testing']},
    ]

    ranked = selector.rank_agents(task_features, available_agents)
    print(f"   –ó–∞–¥–∞—á–∞: medium —Å–ª–æ–∂–Ω–æ—Å—Ç—å, —Ç—Ä–µ–±—É–µ—Ç—Å—è security")
    print(f"   –¢–æ–ø-3 –∞–≥–µ–Ω—Ç–∞:")
    for i, agent in enumerate(ranked, 1):
        score = agent.get('ml_score', agent.get('rule_score', 0))
        print(f"      {i}. {agent['type']}: –æ—Ü–µ–Ω–∫–∞ {score:.3f}")


def populate_learning_library():
    """–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –æ–±—É—á–µ–Ω–∏—è –ø—Ä–∏–º–µ—Ä–∞–º–∏."""
    print("\n" + "="*70)
    print("üìö –ó–ê–ü–û–õ–ù–ï–ù–ò–ï –ë–ò–ë–õ–ò–û–¢–ï–ö–ò –û–ë–£–ß–ï–ù–ò–Ø (LearningLibrary)")
    print("="*70)

    try:
        from src.ml.learning_library import LearningLibrary
    except ImportError as e:
        print(f"‚ùå –ü—Ä–æ–ø—É—Å–∫: –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ ({e})")
        print("üí° pip install chromadb sentence-transformers")
        return

    library = LearningLibrary()

    # –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω—ã—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
    patterns = [
        {
            'task_id': 'pattern_001',
            'description': '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –≤ API',
            'solution': '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É PyJWT, —Å–æ–∑–¥–∞—Ç—å middleware –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤, —Ö—Ä–∞–Ω–∏—Ç—å refresh tokens –≤ Redis',
            'metadata': {'complexity': 'medium', 'success_score': 0.95}
        },
        {
            'task_id': 'pattern_002',
            'description': '–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –º–µ–¥–ª–µ–Ω–Ω—ã—Ö SQL –∑–∞–ø—Ä–æ—Å–æ–≤',
            'solution': '–î–æ–±–∞–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å EXPLAIN –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞, –ø–µ—Ä–µ–ø–∏—Å–∞—Ç—å N+1 –∑–∞–ø—Ä–æ—Å—ã',
            'metadata': {'complexity': 'complex', 'success_score': 0.88}
        },
        {
            'task_id': 'pattern_003',
            'description': '–í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Ñ–æ—Ä–º—ã',
            'solution': '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å Pydantic –¥–ª—è —Å—Ö–µ–º –≤–∞–ª–∏–¥–∞—Ü–∏–∏, —Å–æ–∑–¥–∞—Ç—å –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä @validate –¥–ª—è endpoints',
            'metadata': {'complexity': 'simple', 'success_score': 0.92}
        },
    ]

    for pattern in patterns:
        library.add_pattern(
            task_id=pattern['task_id'],
            description=pattern['description'],
            solution=pattern['solution'],
            metadata=pattern['metadata']
        )

    print(f"‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ {len(patterns)} –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –±–∏–±–ª–∏–æ—Ç–µ–∫—É")

    # –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∏—Å–∫–∞
    print("\nüîç –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–æ–∏—Å–∫–∞:")
    query = "–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π?"
    results = library.search_similar(query, top_k=2)

    print(f"   –ó–∞–ø—Ä–æ—Å: '{query}'")
    print(f"   –ù–∞–π–¥–µ–Ω–æ {len(results)} –ø–æ—Ö–æ–∂–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤:")
    for i, result in enumerate(results, 1):
        print(f"      {i}. {result['description']}")
        print(f"         –†–µ—à–µ–Ω–∏–µ: {result['solution'][:80]}...")
        print(f"         –°—Ö–æ–¥—Å—Ç–≤–æ: {result['similarity']:.2%}")

    # –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    stats = library.get_statistics()
    print(f"\nüìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏:")
    print(f"   - –í—Å–µ–≥–æ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤: {stats['total_patterns']}")
    print(f"   - –°—Ä–µ–¥–Ω–∏–π success score: {stats['average_success_score']:.2%}")


def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è –º–æ–¥–µ–ª–µ–π."""
    import argparse

    parser = argparse.ArgumentParser(description='–û–±—É—á–µ–Ω–∏–µ ML –º–æ–¥–µ–ª–µ–π –¥–ª—è –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω–æ–≥–æ —Ä–æ—É—Ç–∏–Ω–≥–∞')
    parser.add_argument('--synthetic', action='store_true',
                       help='–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏–Ω—Ç–µ—Ç–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±—É—á–µ–Ω–∏—è')
    parser.add_argument('--classifier-only', action='store_true',
                       help='–û–±—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ TaskClassifier')
    parser.add_argument('--selector-only', action='store_true',
                       help='–û–±—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ AgentSelector')
    parser.add_argument('--library-only', action='store_true',
                       help='–ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ç–æ–ª—å–∫–æ LearningLibrary')

    args = parser.parse_args()

    print("="*70)
    print("üöÄ –û–ë–£–ß–ï–ù–ò–ï ML –ú–û–î–ï–õ–ï–ô –î–õ–Ø –ò–ù–¢–ï–õ–õ–ï–ö–¢–£–ê–õ–¨–ù–û–ì–û –†–û–£–¢–ò–ù–ì–ê")
    print("="*70)
    print(f"üìÖ –î–∞—Ç–∞: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")

    # –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –º–æ–¥–µ–ª–µ–π
    os.makedirs('data/models', exist_ok=True)

    # –û–±—É—á–µ–Ω–∏–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
    if args.classifier_only:
        train_task_classifier(use_synthetic=args.synthetic)
    elif args.selector_only:
        train_agent_selector()
    elif args.library_only:
        populate_learning_library()
    else:
        # –û–±—É—á–∏—Ç—å –≤—Å—ë
        train_task_classifier(use_synthetic=args.synthetic)
        train_agent_selector()
        populate_learning_library()

    print("\n" + "="*70)
    print("‚úÖ –û–ë–£–ß–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
    print("="*70)
    print("\nüí° –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–µ–π:")
    print("   from src.ml import TaskClassifier, AgentSelector, LearningLibrary")
    print("   classifier = TaskClassifier()")
    print("   classifier.load('data/models/task_classifier.pkl')")
    print("   prediction = classifier.predict('–î–æ–±–∞–≤—å –≤–∞–ª–∏–¥–∞—Ü–∏—é email')")


if __name__ == '__main__':
    main()
